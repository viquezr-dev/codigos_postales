<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAMÁ - CORE V2</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #1a73e8; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        
        /* Estilos de etiquetas y Popups */
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 2px white; font-size: 14px; }
        .micro-label-fixed { background: none!important; border:none!important; color: #3498db!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 2px white; font-size: 11px; }
        
        .nano-popup .leaflet-popup-content-wrapper { background: #e3f2fd; border: 2px solid #1976d2; border-radius: 8px; width: 220px; }
        .codigo-final { background: #1976d2; color: white; padding: 8px; border-radius: 5px; font-size: 16px; font-weight: bold; text-align: center; margin: 5px 0; letter-spacing: 1px; }
        
        .btn-nav, .btn-ws { display: inline-block; padding: 8px 10px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin: 2px; border:none; cursor: pointer; }
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAMÁ</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: B4-H6K-2W">
    <button id="search-btn">BUSCAR</button>
</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
// ==============================================
// CONFIGURACIÓN MATEMÁTICA (SIN COLISIONES)
// ==============================================
const GRID_CONFIG = {
    ORIGIN_LAT: 10.0,  // Norte de Panamá
    ORIGIN_LNG: -83.5, // Oeste de Panamá
    RES_MACRO: 0.1,    // ~11km
    RES_MICRO: 0.1 / 24,  // ~460m
    RES_NANO: (0.1 / 24) / 25, // ~18m (Precisión final)
    ALPHABET: "23456789BCDFGHJKLMNPQRSTVWXYZ", // Base 30
    // Límites para evitar colisiones en el índice lineal
    MACROS_X: 70, 
    MACROS_Y: 40
};

const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);

// ==============================================
// LÓGICA DE CODIFICACIÓN (BASE 30)
// ==============================================

function toBase30(num, digits) {
    let result = "";
    let n = Math.floor(num);
    for (let i = 0; i < digits; i++) {
        result = GRID_CONFIG.ALPHABET[n % 30] + result;
        n = Math.floor(n / 30);
    }
    return result;
}

function fromBase30(code) {
    let result = 0;
    for (let i = 0; i < code.length; i++) {
        let char = code[i];
        let val = GRID_CONFIG.ALPHABET.indexOf(char);
        result = result * 30 + val;
    }
    return result;
}

// Genera el código basado en coordenadas
function encodePos(lat, lng) {
    const { ORIGIN_LAT, ORIGIN_LNG, RES_MACRO, RES_MICRO, RES_NANO, MACROS_Y } = GRID_CONFIG;

    // 1. Índices Macro
    let mx = Math.floor((lng - ORIGIN_LNG) / RES_MACRO);
    let my = Math.floor((ORIGIN_LAT - lat) / RES_MACRO);
    // ID lineal único para Macro para evitar colisión X/Y
    let macroID = (mx * MACROS_Y) + my; 
    let macroCode = toBase30(macroID, 2);

    // 2. Índices Micro (dentro de la Macro)
    let microX = Math.floor(((lng - ORIGIN_LNG) % RES_MACRO) / RES_MICRO);
    let microY = Math.floor(((ORIGIN_LAT - lat) % RES_MACRO) / RES_MICRO);
    let microID = (microX * 24) + microY;
    let microCode = toBase30(microID, 3);

    // 3. Índices Nano (dentro de la Micro)
    let nanoX = Math.floor((((lng - ORIGIN_LNG) % RES_MACRO) % RES_MICRO) / RES_NANO);
    let nanoY = Math.floor((((ORIGIN_LAT - lat) % RES_MACRO) % RES_MICRO) / RES_NANO);
    let nanoID = (nanoX * 25) + nanoY;
    let nanoCode = toBase30(nanoID, 2);

    return {
        full: `${macroCode}-${microCode}-${nanoCode}`,
        parts: { macroCode, microCode, nanoCode },
        indices: { mx, my, microX, microY, nanoX, nanoY }
    };
}

// Decodifica el código para obtener el centro del cuadro
function decodePos(fullCode) {
    const parts = fullCode.replace(/\s/g, '').split('-');
    if (parts.length !== 3) return null;

    const { ORIGIN_LAT, ORIGIN_LNG, RES_MACRO, RES_MICRO, RES_NANO, MACROS_Y } = GRID_CONFIG;

    // Decodificar Macro
    let macroID = fromBase30(parts[0]);
    let mx = Math.floor(macroID / MACROS_Y);
    let my = macroID % MACROS_Y;

    // Decodificar Micro
    let microID = fromBase30(parts[1]);
    let microX = Math.floor(microID / 24);
    let microY = microID % 24;

    // Decodificar Nano
    let nanoID = fromBase30(parts[2]);
    let nanoX = Math.floor(nanoID / 25);
    let nanoY = nanoID % 25;

    // Calcular coordenadas (centro del cuadro nano)
    let lng = ORIGIN_LNG + (mx * RES_MACRO) + (microX * RES_MICRO) + (nanoX * RES_NANO) + (RES_NANO/2);
    let lat = ORIGIN_LAT - (my * RES_MACRO) - (microY * RES_MICRO) - (nanoY * RES_NANO) - (RES_NANO/2);

    return [lat, lng];
}

// ==============================================
// DIBUJO DINÁMICO DE GRILLA
// ==============================================

function updateGrid() {
    const z = mymap.getZoom();
    gridLayer.clearLayers();
    labelLayer.clearLayers();

    if (z < 10) return;

    const bounds = mymap.getBounds();
    const { ORIGIN_LAT, ORIGIN_LNG, RES_MACRO, RES_MICRO } = GRID_CONFIG;

    // Dibujar Macros (Zoom 10-13)
    if (z >= 10 && z < 14) {
        for (let x = bounds.getWest(); x <= bounds.getEast(); x += RES_MACRO) {
            for (let y = bounds.getSouth(); y <= bounds.getNorth(); y += RES_MACRO) {
                let snapX = Math.floor((x - ORIGIN_LNG) / RES_MACRO) * RES_MACRO + ORIGIN_LNG;
                let snapY = Math.floor((ORIGIN_LAT - y) / RES_MACRO) * RES_MACRO;
                let lat1 = ORIGIN_LAT - snapY;
                let lng1 = snapX;
                
                L.rectangle([[lat1, lng1], [lat1 - RES_MACRO, lng1 + RES_MACRO]], {
                    color: '#1a73e8', weight: 1, fill: false
                }).addTo(gridLayer);

                let code = encodePos(lat1 - RES_MACRO/2, lng1 + RES_MACRO/2).parts.macroCode;
                L.marker([lat1 - RES_MACRO/2, lng1 + RES_MACRO/2], {
                    icon: L.divIcon({ className: 'watermark-label-fixed', html: code })
                }).addTo(labelLayer);
            }
        }
    }

    // Dibujar Micros (Zoom 15+)
    if (z >= 15) {
        let step = RES_MICRO;
        for (let x = bounds.getWest(); x <= bounds.getEast(); x += step) {
            for (let y = bounds.getSouth(); y <= bounds.getNorth(); y += step) {
                let lat = y; let lng = x;
                let codeInfo = encodePos(lat, lng);
                
                L.rectangle([[lat, lng], [lat + step, lng + step]], {
                    color: '#3498db', weight: 0.5, fill: false, opacity: 0.5
                }).addTo(gridLayer);
            }
        }
    }
}

// ==============================================
// EVENTOS
// ==============================================

mymap.on('click', function(e) {
    selectionLayer.clearLayers();
    let codeInfo = encodePos(e.latlng.lat, e.latlng.lng);
    
    // Resaltar cuadro Nano
    const { RES_NANO } = GRID_CONFIG;
    // Ajustar al inicio del cuadro para el dibujo
    let snapLat = ORIGIN_LAT - Math.floor((ORIGIN_LAT - e.latlng.lat) / RES_NANO) * RES_NANO;
    let snapLng = ORIGIN_LNG + Math.floor((e.latlng.lng - ORIGIN_LNG) / RES_NANO) * RES_NANO;

    L.rectangle([[snapLat, snapLng], [snapLat - RES_NANO, snapLng + RES_NANO]], {
        color: 'red', weight: 2, fillColor: 'red', fillOpacity: 0.2
    }).addTo(selectionLayer);

    L.popup({ className: 'nano-popup' })
        .setLatLng(e.latlng)
        .setContent(`
            <div style="text-align:center">
                <small>CÓDIGO POSTAL</small>
                <div class="codigo-final">${codeInfo.full}</div>
                <div style="font-size:10px; margin-bottom:10px;">
                    GPS: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}
                </div>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">GOOGLE MAPS</button>
                <button class="btn-ws" onclick="window.open('https://wa.me/?text=Mi+ubicación+postal:+${codeInfo.full}')">WHATSAPP</button>
            </div>
        `).openOn(mymap);
});

$('#search-btn').click(function() {
    let query = $('#search-input').val().toUpperCase();
    let coords = decodePos(query);
    if (coords) {
        mymap.setView(coords, 18);
        L.marker(coords).addTo(selectionLayer).bindPopup("Ubicación encontrada: " + query).openPopup();
    } else {
        alert("Código no válido. Formato: XX-XXX-XX");
    }
});

mymap.on('moveend', updateGrid);
updateGrid();

</script>
</body>
</html>
