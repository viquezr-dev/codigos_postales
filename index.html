<!DOCTYPE html>
<html lang="es">
<head>
    <title>SISTEMA POSTAL PANAMÁ V6</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; background: #f0f0f0; }
        
        /* Tooltips personalizados para Watermarks (Centrado Nativo) */
        .leaflet-tooltip.watermark-tooltip {
            background: transparent!important;
            border: none!important;
            box-shadow: none!important;
            color: rgba(0,0,0,0.5);
            font-weight: bold;
            font-family: monospace;
            pointer-events: none!important;
        }

        .label-macro { color: #1a73e8!important; font-size: 16px; opacity: 0.6; }
        .label-micro { color: #e67e22!important; font-size: 11px; opacity: 0.7; }
        .label-nano { color: #2c3e50!important; font-size: 9px; opacity: 0.5; }

        .map-header { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; width: 100%; pointer-events: none; }
        .map-header h1 { margin: 0; font-size: 14px; color: #1a2a6c; font-family: sans-serif; background: white; padding: 8px 20px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: inline-block; }
        
        .codigo-progresivo { background: #1a2a6c; color: white; padding: 12px; border-radius: 8px; font-size: 18px; font-weight: bold; font-family: monospace; text-align: center; }
    </style>
</head>
<body>

<div class="map-header"><h1>SISTEMA POSTAL DE PANAMÁ</h1></div>
<div id="mapid"></div>

<script>
// --- CONFIGURACIÓN ---
const ORIGIN = { lat: 10.0, lng: -83.0 };
const PANAMA_LIMITS = { N: 10.0, S: 7.0, W: -83.0, E: -77.0 };
const PARAMS = {
    RES_MACRO: 0.1,
    RES_MICRO: 0.1 / 24,
    RES_NANO: (0.1 / 24) / 25,
    ALFA: "23456789ABCDEFGHJKLMNPQRSTVWXYZ",
    MAX_Y_MACRO: 30, MAX_Y_MICRO: 24, MAX_Y_NANO: 25
};

// Mapa inicia en una vista general (Zoom 8)
const mymap = L.map('mapid', { zoomControl: false, zoomSnap: 0.1 }).setView([8.5, -80.0], 8);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mymap);

const layerMacro = L.layerGroup().addTo(mymap);
const layerMicro = L.layerGroup().addTo(mymap);
const layerNano = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);

function encode(num, len) {
    let s = "";
    let n = Math.abs(Math.floor(num));
    for (let i = 0; i < len; i++) { s = PARAMS.ALFA[n % 30] + s; n = Math.floor(n / 30); }
    return s;
}

function getSnappedCoords(lat, lng, step) {
    const snapLng = Math.floor((lng - ORIGIN.lng) / step) * step + ORIGIN.lng;
    const snapLat = ORIGIN.lat - Math.ceil((ORIGIN.lat - lat) / step) * step;
    return { lat: snapLat, lng: snapLng };
}

function getInfo(lat, lng) {
    if (lat > PANAMA_LIMITS.N || lat < PANAMA_LIMITS.S || lng < PANAMA_LIMITS.W || lng > PANAMA_LIMITS.E) return null;
    let mx = Math.floor((lng - ORIGIN.lng) / PARAMS.RES_MACRO);
    let my = Math.floor((ORIGIN.lat - lat) / PARAMS.RES_MACRO);
    let microX = Math.floor(((lng - ORIGIN.lng) % PARAMS.RES_MACRO) / PARAMS.RES_MICRO);
    let microY = Math.floor(((ORIGIN.lat - lat) % PARAMS.RES_MACRO) / PARAMS.RES_MICRO);
    let nanoX = Math.floor((((lng - ORIGIN.lng) % PARAMS.RES_MACRO) % PARAMS.RES_MICRO) / PARAMS.RES_NANO);
    let nanoY = Math.floor((((ORIGIN.lat - lat) % PARAMS.RES_MACRO) % PARAMS.RES_MICRO) / PARAMS.RES_NANO);
    return { 
        macro: encode((mx * PARAMS.MAX_Y_MACRO) + my, 2), 
        micro: encode((microX * PARAMS.MAX_Y_MICRO) + microY, 3), 
        nano: encode((nanoX * PARAMS.MAX_Y_NANO) + nanoY, 2) 
    };
}

function render() {
    layerMacro.clearLayers();
    layerMicro.clearLayers();
    layerNano.clearLayers();
    
    const z = mymap.getZoom();
    const b = mymap.getBounds();

    // 1. DIBUJAR MACRO (Frontera siempre visible desde zoom 10)
    if (z >= 10) {
        drawGridLevel(PARAMS.RES_MACRO, layerMacro, 'label-macro', 2, '#1a73e8', 0.4);
    }
    
    // 2. DIBUJAR MICRO (Desde zoom 14)
    if (z >= 14) {
        drawGridLevel(PARAMS.RES_MICRO, layerMicro, 'label-micro', 1, '#e67e22', 0.2);
    }

    // 3. DIBUJAR NANO (Desde zoom 17)
    if (z >= 17.5) {
        drawGridLevel(PARAMS.RES_NANO, layerNano, 'label-nano', 0.5, '#2c3e50', 0.1);
    }
}

function drawGridLevel(step, layer, labelClass, weight, color, opacity) {
    const b = mymap.getBounds();
    const z = mymap.getZoom();
    let start = getSnappedCoords(b.getSouth(), b.getWest(), step);
    let count = 0;

    for (let lo = start.lng; lo < b.getEast() && lo < PANAMA_LIMITS.E; lo += step) {
        for (let la = start.lat; la < b.getNorth() && la < PANAMA_LIMITS.N; la += step) {
            if (count++ > 500) return; // Protección para que no se congele

            let data = getInfo(la + step/2, lo + step/2);
            if (!data) continue;

            // Dibujar Cuadro
            L.rectangle([[la, lo], [la + step, lo + step]], {
                color: color, weight: weight, fill: false, opacity: opacity, interactive: false
            }).addTo(layer);

            // Solo poner texto si es el nivel predominante para no saturar
            let showText = false;
            let txt = "";
            if (labelClass === 'label-macro' && z < 14) { showText = true; txt = data.macro; }
            if (labelClass === 'label-micro' && z >= 14 && z < 17.5) { showText = true; txt = data.micro; }
            if (labelClass === 'label-nano' && z >= 17.5) { showText = true; txt = data.nano; }

            if (showText) {
                L.marker([la + step/2, lo + step/2], { icon: L.divIcon({className: 'invisible-icon'}) })
                 .bindTooltip(txt, { permanent: true, direction: 'center', className: `watermark-tooltip ${labelClass}` })
                 .addTo(layer);
            }
        }
    }
}

mymap.on('click', function(e) {
    const z = mymap.getZoom();
    let step = (z >= 17.5) ? PARAMS.RES_NANO : (z >= 14 ? PARAMS.RES_MICRO : PARAMS.RES_MACRO);
    
    const snap = getSnappedCoords(e.latlng.lat, e.latlng.lng, step);
    const res = getInfo(snap.lat + step/2, snap.lng + step/2);
    if (!res) return;

    selectionLayer.clearLayers();
    let codigoDisplay = (z >= 17.5) ? `${res.macro}-${res.micro}-${res.nano}` : (z >= 14 ? `${res.macro}-${res.micro}` : res.macro);

    L.rectangle([[snap.lat, snap.lng], [snap.lat + step, snap.lng + step]], {
        color: '#f1c40f', weight: 4, fillOpacity: 0.4, fillColor: '#f1c40f'
    }).addTo(selectionLayer);

    L.popup().setLatLng(e.latlng).setContent(`<div class="codigo-progresivo">${codigoDisplay}</div>`).openOn(mymap);
});

mymap.on('moveend', render);
render();
</script>

<style> .invisible-icon { background: none; border: none; } </style>
</body>
</html>
