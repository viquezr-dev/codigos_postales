<!DOCTYPE html>
<html lang="es">
<head>
    <title>SISTEMAS POSTALES DE PANAM√Å</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; background: #ddd; }
        .search-container { position: absolute; top: 10px; right: 10px; z-index: 5000; display: flex; gap: 5px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; }
        #search-input { flex: 1; border: 1px solid #ccc; padding: 5px; outline: none; font-family: monospace; font-size: 14px; text-transform: uppercase; border-radius: 4px; }
        #search-btn { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .leaflet-top.leaflet-right { margin-top: 70px !important; }
        .leaflet-tooltip.watermark-tooltip { background: transparent!important; border: none!important; box-shadow: none!important; color: rgba(0,0,0,0.4); font-weight: bold; font-family: monospace; text-shadow: 1px 1px 0px white; pointer-events: none; }
        .label-macro { color: #1a73e8!important; font-size: 14px; }
        .label-micro { color: #e67e22!important; font-size: 10px; }
        .codigo-final { background: #1a2a6c; color: white; padding: 12px; border-radius: 6px; font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 8px; border: 2px solid #f1c40f; font-family: monospace; }
        .popup-header { font-weight: bold; display: block; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 3px; text-align: center; font-size: 11px; text-transform: uppercase; color: #666; }
        .btn-container { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; justify-content: center; }
        .btn-ws { background: #25D366; color: white !important; padding: 8px; border-radius: 4px; text-decoration: none; font-size: 10px; font-weight: bold; text-align: center; }
        .btn-maps { background: #4285F4; color: white !important; padding: 8px; border-radius: 4px; text-decoration: none; font-size: 10px; font-weight: bold; text-align: center; }
        .btn-cercana { background: #003366; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: bold; grid-column: span 2; }
        .locate-button { position: absolute; bottom: 30px; left: 10px; z-index: 1000; background: white; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .inv { background: none; border: none; }
        .map-title { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; text-align: center; pointer-events: none; width: 100%; }
        .map-title h1 { margin: 0; font-size: 20px; color: #1a2a6c; text-transform: uppercase; font-weight: 900; letter-spacing: 1px; text-shadow: 2px 2px 0px #fff; }
    </style>
</head>
<body>

<div class="map-title">
    <h1>SISTEMAS POSTALES DE PANAM√Å</h1>
    <span style="font-weight: bold; color: #333; text-shadow: 1px 1px 0px #fff;">COTEL - PANAMA</span>
</div>

<div class="search-container">
    <input type="text" id="search-input" placeholder="BUSCAR C√ìDIGO O ESTAFETA..." maxlength="15">
    <button id="search-btn" onclick="buscarCodigo()">IR</button>
</div>

<button class="locate-button" onclick="findMe()">üß≠</button>
<div id="mapid"></div>

<script>
const ORIGIN = { lat: 10.0, lng: -83.0 };
const ALFA = "23456789ABCDEFGHJKLMNPQRSTVWXYZ";
const R_3M = 0.000027; 

const PARAMS = { RES_NANO: R_3M, RES_MICRO: R_3M * 30, RES_MACRO: R_3M * 900 };

const mymap = L.map('mapid', { zoomSnap: 0.1, zoomControl: false, maxZoom: 22 }).setView([8.5, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22, maxNativeZoom: 19 }).addTo(mymap);
L.control.zoom({ position: 'bottomright' }).addTo(mymap);

// Capas
const layerZonas = L.geoJSON(null, { 
    style: { color: "#333", weight: 1.5, fillOpacity: 0.1, fillColor: "#3498db" },
    onEachFeature: (f, l) => {
        l.on({
            mouseover: (e) => { e.target.setStyle({ weight: 3, color: '#f1c40f', fillOpacity: 0.3 }); },
            mouseout: (e) => { layerZonas.resetStyle(e.target); },
            click: (e) => { seleccionar(e.latlng.lat, e.latlng.lng, f.properties.VM_LEVEL); L.DomEvent.stopPropagation(e); }
        });
    }
}).addTo(mymap);

const layerMacro = L.layerGroup().addTo(mymap);
const layerMicro = L.layerGroup().addTo(mymap);
const layerLocalNano = L.layerGroup().addTo(mymap);
const layerRutas = L.layerGroup().addTo(mymap);
const layerEstafetas = L.layerGroup().addTo(mymap);
const layerMiUbicacion = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const distanceLayer = L.layerGroup().addTo(mymap);

// Carga de Datos
fetch('estafetas.geojson').then(r => r.json()).then(data => layerZonas.addData(data)).catch(()=>{});
fetch('estafetasl.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, { style: { color: 'red', weight: 2.5, opacity: 0.5 }, onEachFeature: (f,l) => l.bindPopup(`RUTA: ${f.properties.RUTA}`) }).addTo(layerRutas);
}).catch(()=>{});
fetch('estafetasp.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, {
        pointToLayer: (f, ll) => L.circleMarker(ll, { radius: 6, fillColor: '#27ae60', color: '#fff', weight: 2, fillOpacity: 1 }),
        onEachFeature: (f, l) => { l.bindPopup(`<b>ESTAFETA:</b> ${f.properties.ESTAF_NAME || 'N/A'}`); }
    }).addTo(layerEstafetas);
}).catch(()=>{});

function encode(num, len) {
    let s = ""; let n = Math.abs(Math.floor(num));
    for (let i = 0; i < len; i++) { s = ALFA[n % 30] + s; n = Math.floor(n / 30); }
    return s;
}

function getGridInfo(lat, lng) {
    const gx = Math.round((lng - ORIGIN.lng) / PARAMS.RES_NANO);
    const gy = Math.round((ORIGIN.lat - lat) / PARAMS.RES_NANO);
    return {
        macro: encode((Math.floor(gy / 900) * 2000) + Math.floor(gx / 900), 3),
        micro: encode((Math.floor((gy % 900) / 30) * 30) + Math.floor((gx % 900) / 30), 3),
        nano: encode(((gy % 30 + 30) % 30 * 30) + (gx % 30 + 30) % 30, 2)
    };
}

function render() {
    layerMacro.clearLayers(); layerMicro.clearLayers();
    const z = mymap.getZoom(); const b = mymap.getBounds();
    const drawGrid = (step, layer, labelClass, color, weight, opacity) => {
        const sX = Math.floor((b.getWest() - ORIGIN.lng) / step);
        const sY = Math.floor((ORIGIN.lat - b.getNorth()) / step);
        const eX = Math.ceil((b.getEast() - ORIGIN.lng) / step);
        const eY = Math.ceil((ORIGIN.lat - b.getSouth()) / step);
        if ((eX - sX) * (eY - sY) > 900) return;
        for (let ix = sX; ix <= eX; ix++) {
            for (let iy = sY; iy <= eY; iy++) {
                const lon = ORIGIN.lng + (ix * step); const lat = ORIGIN.lat - (iy * step);
                L.rectangle([[lat, lon], [lat - step, lon + step]], { color, weight, fill: false, opacity, interactive: false }).addTo(layer);
                if (labelClass && ((labelClass === 'label-macro' && z >= 11 && z < 13.5) || (labelClass === 'label-micro' && z >= 14.5 && z < 17.5))) {
                    const info = getGridInfo(lat - step/2, lon + step/2);
                    L.marker([lat - step/2, lon + step/2], { icon: L.divIcon({className: 'inv'}) })
                     .bindTooltip(labelClass === 'label-macro' ? info.macro : info.micro, { permanent: true, direction: 'center', className: `watermark-tooltip ${labelClass}` }).addTo(layer);
                }
            }
        }
    };
    if (z >= 10) drawGrid(PARAMS.RES_MACRO, layerMacro, 'label-macro', '#1a73e8', 1, 0.2);
    if (z >= 14) drawGrid(PARAMS.RES_MICRO, layerMicro, 'label-micro', '#e67e22', 0.6, 0.2);
}

function seleccionar(lat, lng, forcedZonaID = null) {
    selectionLayer.clearLayers(); layerLocalNano.clearLayers(); distanceLayer.clearLayers();
    const z = mymap.getZoom();
    let zonaID = forcedZonaID;
    if (!zonaID) {
        layerZonas.eachLayer(l => { if (l instanceof L.Polygon && l.getBounds().contains([lat, lng])) zonaID = l.feature.properties.VM_LEVEL; });
    }
    if (!zonaID) return;

    const res = getGridInfo(lat, lng);
    let step = (z < 13) ? 0 : (z < 16) ? PARAMS.RES_MACRO : (z < 18.5) ? PARAMS.RES_MICRO : PARAMS.RES_NANO;
    let zonaLimpia = zonaID.toString().charAt(0) + zonaID.toString().substring(3);
    let cod = (z < 13) ? zonaID : (z < 16) ? `${zonaID}-${res.macro}` : (z < 18.5) ? `${zonaID}-${res.macro}-${res.micro}` : `${zonaLimpia}${res.macro}-${res.micro}${res.nano}`;

    if (step > 0) {
        const iX = Math.floor((lng - ORIGIN.lng) / step); const iY = Math.floor((ORIGIN.lat - lat) / step);
        L.rectangle([[ORIGIN.lat - iY*step, ORIGIN.lng + iX*step], [ORIGIN.lat - (iY+1)*step, ORIGIN.lng + (iX+1)*step]], { color: '#e74c3c', weight: 3, fillOpacity: 0.3 }).addTo(selectionLayer);
    }

    if (z >= 18.5) {
        const mX = Math.floor((lng - ORIGIN.lng) / PARAMS.RES_MICRO); const mY = Math.floor((ORIGIN.lat - lat) / PARAMS.RES_MICRO);
        for(let i=0; i<30; i++) { for(let j=0; j<30; j++) {
            L.rectangle([[ORIGIN.lat - (mY*PARAMS.RES_MICRO + i*R_3M), ORIGIN.lng + (mX*PARAMS.RES_MICRO + j*R_3M)], [ORIGIN.lat - (mY*PARAMS.RES_MICRO + (i+1)*R_3M), ORIGIN.lng + (mX*PARAMS.RES_MICRO + (j+1)*R_3M)]], { color: '#2c3e50', weight: 0.5, fill: false, opacity: 0.15 }).addTo(layerLocalNano);
        }}
    }

    L.marker([lat, lng], { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [20, 32], iconAnchor: [10, 32] }) })
     .addTo(selectionLayer).bindPopup(`
        <span class="popup-header">C√ìDIGO POSTAL</span>
        <div class="codigo-final">${cod}</div>
        <div class="btn-container">
            <a href="https://wa.me/?text=Mi+Direcci√≥n+Postal:+${cod}" target="_blank" class="btn-ws">WHATSAPP</a>
            <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" class="btn-maps">GOOGLE MAPS</a>
            <button onclick="buscarEstafetaCercana(${lat}, ${lng})" class="btn-cercana">üìç BUSCAR ESTAFETA CERCANA</button>
        </div>
     `, { offset: L.point(0, -30) }).openPopup();
}

function buscarCodigo() {
    const val = document.getElementById('search-input').value.toUpperCase();
    let encontrado = false;
    layerEstafetas.eachLayer(l => {
        if (l.feature && l.feature.properties.VM_LEVEL === val) {
            mymap.setView(l.getLatLng(), 18);
            seleccionar(l.getLatLng().lat, l.getLatLng().lng, val);
            encontrado = true;
        }
    });
    if(!encontrado) alert("C√ìDIGO NO ENCONTRADO O FUERA DE RANGO");
}

function buscarEstafetaCercana(lat, lng) {
    distanceLayer.clearLayers();
    const userPt = L.latLng(lat, lng); let cercana = null; let dMin = Infinity;
    layerEstafetas.eachLayer(l => {
        const d = userPt.distanceTo(l.getLatLng());
        if (d < dMin) { dMin = d; cercana = l; }
    });
    if (cercana) {
        L.polyline([userPt, cercana.getLatLng()], { color: '#c0392b', weight: 3, dashArray: '5,5' }).addTo(distanceLayer);
        cercana.openPopup();
    }
}

function findMe() { mymap.locate({setView: true, maxZoom: 19}); }
mymap.on('locationfound', (e) => {
    layerMiUbicacion.clearLayers();
    L.circleMarker(e.latlng, {radius: 8, color: 'white', fillColor: '#1a73e8', fillOpacity: 1, weight: 3}).addTo(layerMiUbicacion);
    seleccionar(e.latlng.lat, e.latlng.lng);
});

mymap.on('click', (e) => seleccionar(e.latlng.lat, e.latlng.lng));
mymap.on('moveend', render);
mymap.on('zoomend', render);

L.control.layers(null, { 
    "üî≤ Zonas": layerZonas, "üõ£Ô∏è Rutas": layerRutas, "üü¶ Macro": layerMacro, "üüß Micro": layerMicro, "‚¨õ Grid 3m": layerLocalNano, "üìç Estafetas": layerEstafetas
}, { collapsed: false }).addTo(mymap);

render();
</script>
</body>
</html>
