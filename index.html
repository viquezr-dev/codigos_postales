<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL PANAM</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 250px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .leaflet-top.leaflet-right { top: 80px !important; }
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; font-weight: bold; }
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 14px; font-weight: bold; }
        .micro-label-fixed { background: none!important; border:none!important; color: #3498db!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 11px; font-weight: bold; }
        .nano-label-fixed { background: none!important; border:none!important; color: #2980b9!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 9px; }
        .nano-selection-label { background: none!important; border: none!important; text-align: center; pointer-events: none!important; }
        .micro-selection-label { background: none!important; border: none!important; text-align: center; pointer-events: none!important; }
        .btn-nav, .btn-ws { display: inline-block; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin: 2px; border:none; cursor: pointer; }
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
        .locate-button { width: 30px; height: 30px; line-height: 30px; text-align: center; display: block; text-decoration: none; color: black; background: white; font-size: 18px; cursor: pointer; }
        .user-location-icon { text-align: center; font-size: 20px; }
        .highlighted-polygon { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { fill-opacity: 0.3; stroke-width: 3; }
            50% { fill-opacity: 0.7; stroke-width: 4; }
            100% { fill-opacity: 0.3; stroke-width: 3; }
        }
        .warning-popup .leaflet-popup-content-wrapper {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }
        .warning-popup .leaflet-popup-tip {
            background: #ffc107;
        }
        .code-display {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 1px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px solid #3498db;
            margin: 10px 0;
            text-align: center;
        }
        .simple-popup { min-width: 200px; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL PANAM</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: 8A9B-X3Y7-Z5W2">
    <button id="search-btn">BUSCAR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
// ==================== CONFIGURACIN ====================
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// TODAS LAS CAPAS ORIGINALES
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawZonas = null;
let labelsEnabled = true;

// ==================== SISTEMA PanamaCode ====================
const BASE32 = "23456789ABCDEFGHJKMNPQRSTUVWXYZ";

// Codificar a Base32 (2 chars)
function encodeBase32(num) {
    const char1 = BASE32[Math.floor(num / 32)];
    const char2 = BASE32[num % 32];
    return char1 + char2;
}

// Generar PanamaCode (12 caracteres)
function generatePanamaCode(lat, lng, polygon) {
    const bounds = L.geoJSON(polygon).getBounds();
    
    // Posici贸n relativa dentro del pol铆gono
    const relX = (lng - bounds.getWest()) / (bounds.getEast() - bounds.getWest());
    const relY = (lat - bounds.getSouth()) / (bounds.getNorth() - bounds.getSouth());
    
    const safeRelX = Math.max(0.001, Math.min(0.999, relX));
    const safeRelY = Math.max(0.001, Math.min(0.999, relY));
    
    // ndices micro (2424)
    const microIx = Math.floor(safeRelX * 24);
    const microIy = Math.floor(safeRelY * 24);
    
    // ndices nano (2525 dentro de micro)
    const nix = Math.floor((safeRelX * 24 - microIx) * 25);
    const niy = Math.floor((safeRelY * 24 - microIy) * 25);
    
    // C贸digo 煤nico basado en posici贸n absoluta en Panam谩
    const absLat = Math.floor((lat - 7.0) * 10000); // Base en latitud de Panam谩
    const absLng = Math.floor((lng + 83.0) * 10000); // Base en longitud de Panam谩
    
    const regionCode = encodeBase32(absLat % 1024) + encodeBase32(absLng % 1024);
    const microCode = encodeBase32(microIx) + encodeBase32(microIy);
    const nanoCode = encodeBase32(nix) + encodeBase32(niy);
    
    return `${regionCode}-${microCode}-${nanoCode}`;
}

// ==================== VISUALIZACIN ====================

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    
    if (!rawZonas) return;
    
    const z = mymap.getZoom();
    const bounds = mymap.getBounds();
    
    // Labels macro (regiones)
    if (z >= 9 && z < 14 && labelsEnabled) {
        rawZonas.features.forEach(feature => {
            const featureBounds = L.geoJSON(feature).getBounds();
            if (bounds.intersects(featureBounds)) {
                const center = featureBounds.getCenter();
                
                // Generar c贸digo de regi贸n para el centro
                const regionCode = generatePanamaCode(center.lat, center.lng, feature).split('-')[0];
                
                L.marker(center, {
                    icon: L.divIcon({ 
                        className: 'watermark-label-fixed', 
                        html: regionCode, 
                        iconSize: [60, 20] 
                    })
                }).addTo(labelLayer);
            }
        });
    }
    
    // Grid micro (2424) - LNEAS MS VISIBLES
    if (z >= 14) {
        drawGrid(z);
    }
}

function drawGrid(zoom) {
    const bounds = mymap.getBounds();
    
    rawZonas.features.forEach(feature => {
        const featureBounds = L.geoJSON(feature).getBounds();
        if (!bounds.intersects(featureBounds)) return;
        
        const polygonBounds = featureBounds;
        
        // LNEAS MICRO - MUCHO MS VISIBLES
        if (zoom >= 14 && zoom < 17) {
            const cellSizeX = (polygonBounds.getEast() - polygonBounds.getWest()) / 24;
            const cellSizeY = (polygonBounds.getNorth() - polygonBounds.getSouth()) / 24;
            
            // L铆neas verticales - MS GRUESAS
            for (let i = 0; i <= 24; i++) {
                const lng = polygonBounds.getWest() + i * cellSizeX;
                L.polyline([
                    [polygonBounds.getSouth(), lng],
                    [polygonBounds.getNorth(), lng]
                ], {
                    color: '#3498db',
                    weight: 2,  // MS GRUESO
                    opacity: 0.7,  // MS VISIBLE
                    dashArray: '3, 3'
                }).addTo(gridLayer);
            }
            
            // L铆neas horizontales - MS GRUESAS
            for (let j = 0; j <= 24; j++) {
                const lat = polygonBounds.getSouth() + j * cellSizeY;
                L.polyline([
                    [lat, polygonBounds.getWest()],
                    [lat, polygonBounds.getEast()]
                ], {
                    color: '#3498db',
                    weight: 2,  // MS GRUESO
                    opacity: 0.7,  // MS VISIBLE
                    dashArray: '3, 3'
                }).addTo(gridLayer);
            }
            
            // Labels micro
            if (labelsEnabled) {
                for (let i = 0; i < 24; i += 3) {
                    for (let j = 0; j < 24; j += 3) {
                        const centerLng = polygonBounds.getWest() + (i + 0.5) * cellSizeX;
                        const centerLat = polygonBounds.getSouth() + (j + 0.5) * cellSizeY;
                        
                        if (leafletPip.pointInLayer([centerLng, centerLat], L.geoJSON(feature)).length > 0) {
                            const microCode = encodeBase32(i) + encodeBase32(j);
                            
                            L.marker([centerLat, centerLng], {
                                icon: L.divIcon({ 
                                    className: 'micro-label-fixed', 
                                    html: microCode, 
                                    iconSize: [50, 15] 
                                })
                            }).addTo(labelLayer);
                        }
                    }
                }
            }
        }
        
        // LNEAS NANO - MS VISIBLES
        if (zoom >= 17) {
            const microSizeX = (polygonBounds.getEast() - polygonBounds.getWest()) / 24;
            const microSizeY = (polygonBounds.getNorth() - polygonBounds.getSouth()) / 24;
            const nanoSizeX = microSizeX / 25;
            const nanoSizeY = microSizeY / 25;
            
            // L铆neas nano (cada 5 para no saturar) - MS VISIBLES
            for (let i = 0; i <= 24 * 25; i += 5) {
                const lng = polygonBounds.getWest() + i * nanoSizeX;
                L.polyline([
                    [bounds.getSouth(), lng],
                    [bounds.getNorth(), lng]
                ], {
                    color: '#2980b9',
                    weight: 1,  // VISIBLE
                    opacity: 0.4,
                    dashArray: '2, 2'
                }).addTo(gridLayer);
            }
            
            for (let j = 0; j <= 24 * 25; j += 5) {
                const lat = polygonBounds.getSouth() + j * nanoSizeY;
                L.polyline([
                    [lat, bounds.getWest()],
                    [lat, bounds.getEast()]
                ], {
                    color: '#2980b9',
                    weight: 1,  // VISIBLE
                    opacity: 0.4,
                    dashArray: '2, 2'
                }).addTo(gridLayer);
            }
        }
    });
}

// ==================== EVENTO CLIC (3 NIVELES) ====================

mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    
    if (!rawZonas) return;
    
    // Verificar si est谩 dentro de pol铆gono postal
    const point = [e.latlng.lng, e.latlng.lat];
    const polygons = leafletPip.pointInLayer(point, L.geoJSON(rawZonas));
    
    if (polygons.length === 0) {
        showNoCodePopup(e.latlng);
        return;
    }
    
    const feature = polygons[0].feature;
    const bounds = L.geoJSON(feature).getBounds();
    const z = mymap.getZoom();
    
    // Generar c贸digo
    const fullCode = generatePanamaCode(e.latlng.lat, e.latlng.lng, feature);
    const [regionCode, microCode, nanoCode] = fullCode.split('-');
    
    let displayCode = '';
    let titulo = '';
    
    // NIVEL MACRO (zoom < 14)
    if (z < 14) {
        titulo = "REGIN";
        displayCode = regionCode;
        
        L.geoJSON(feature, {
            style: {
                color: "#1a73e8", 
                weight: 4, 
                fillColor: "#1a73e8",
                fillOpacity: 0.3,
                className: 'highlighted-polygon'
            }
        }).addTo(selectionLayer);
    }
    
    // NIVEL MICRO (zoom 14-16)
    else if (z >= 14 && z < 17) {
        titulo = "SECTOR";
        displayCode = `${regionCode}-${microCode}`;
        
        highlightMicroCell(e.latlng, feature);
    }
    
    // NIVEL NANO (zoom 17+)
    else {
        titulo = "CELDA";
        displayCode = fullCode;
        
        highlightNanoCell(e.latlng, feature);
    }
    
    // Popup SIMPLE
    showSimplePopup(e.latlng, titulo, displayCode);
});

function highlightMicroCell(latlng, feature) {
    const bounds = L.geoJSON(feature).getBounds();
    const relX = (latlng.lng - bounds.getWest()) / (bounds.getEast() - bounds.getWest());
    const relY = (latlng.lat - bounds.getSouth()) / (bounds.getNorth() - bounds.getSouth());
    
    const safeRelX = Math.max(0.001, Math.min(0.999, relX));
    const safeRelY = Math.max(0.001, Math.min(0.999, relY));
    
    const microIx = Math.floor(safeRelX * 24);
    const microIy = Math.floor(safeRelY * 24);
    
    const cellSizeX = (bounds.getEast() - bounds.getWest()) / 24;
    const cellSizeY = (bounds.getNorth() - bounds.getSouth()) / 24;
    
    const cellBounds = [
        [bounds.getSouth() + microIy * cellSizeY, bounds.getWest() + microIx * cellSizeX],
        [bounds.getSouth() + microIy * cellSizeY, bounds.getWest() + (microIx + 1) * cellSizeX],
        [bounds.getSouth() + (microIy + 1) * cellSizeY, bounds.getWest() + (microIx + 1) * cellSizeX],
        [bounds.getSouth() + (microIy + 1) * cellSizeY, bounds.getWest() + microIx * cellSizeX]
    ];
    
    L.polygon(cellBounds, {
        color: "#3498db", 
        weight: 3, 
        fillColor: "#3498db",
        fillOpacity: 0.4,
        className: 'highlighted-polygon'
    }).addTo(selectionLayer);
}

function highlightNanoCell(latlng, feature) {
    const bounds = L.geoJSON(feature).getBounds();
    const relX = (latlng.lng - bounds.getWest()) / (bounds.getEast() - bounds.getWest());
    const relY = (latlng.lat - bounds.getSouth()) / (bounds.getNorth() - bounds.getSouth());
    
    const safeRelX = Math.max(0.001, Math.min(0.999, relX));
    const safeRelY = Math.max(0.001, Math.min(0.999, relY));
    
    const microIx = Math.floor(safeRelX * 24);
    const microIy = Math.floor(safeRelY * 24);
    const nix = Math.floor((safeRelX * 24 - microIx) * 25);
    const niy = Math.floor((safeRelY * 24 - microIy) * 25);
    
    const microSizeX = (bounds.getEast() - bounds.getWest()) / 24;
    const microSizeY = (bounds.getNorth() - bounds.getSouth()) / 24;
    const nanoSizeX = microSizeX / 25;
    const nanoSizeY = microSizeY / 25;
    
    const cellBounds = [
        [bounds.getSouth() + (microIy + niy/25) * microSizeY, bounds.getWest() + (microIx + nix/25) * microSizeX],
        [bounds.getSouth() + (microIy + niy/25) * microSizeY, bounds.getWest() + (microIx + (nix+1)/25) * microSizeX],
        [bounds.getSouth() + (microIy + (niy+1)/25) * microSizeY, bounds.getWest() + (microIx + (nix+1)/25) * microSizeX],
        [bounds.getSouth() + (microIy + (niy+1)/25) * microSizeY, bounds.getWest() + (microIx + nix/25) * microSizeX]
    ];
    
    L.polygon(cellBounds, {
        color: "#2980b9", 
        weight: 2, 
        fillColor: "#2980b9",
        fillOpacity: 0.5,
        className: 'highlighted-polygon'
    }).addTo(selectionLayer);
    
    // Borde micro de referencia
    const microBounds = [
        [bounds.getSouth() + microIy * microSizeY, bounds.getWest() + microIx * microSizeX],
        [bounds.getSouth() + microIy * microSizeY, bounds.getWest() + (microIx + 1) * microSizeX],
        [bounds.getSouth() + (microIy + 1) * microSizeY, bounds.getWest() + (microIx + 1) * microSizeX],
        [bounds.getSouth() + (microIy + 1) * microSizeY, bounds.getWest() + microIx * microSizeX]
    ];
    
    L.polygon(microBounds, {
        color: "#3498db", 
        weight: 1, 
        fillColor: "transparent",
        dashArray: "5, 5",
        opacity: 0.5
    }).addTo(selectionLayer);
}

function showNoCodePopup(latlng) {
    L.popup({ className: 'warning-popup' })
        .setLatLng([latlng.lat + 0.0004, latlng.lng])
        .setContent(`
            <div class="simple-popup">
                <div style="text-align:center; padding: 10px;">
                    <div style="color: #e74c3c; font-size: 14px; margin-bottom: 5px;">
                        锔 SIN CDIGO
                    </div>
                    <div style="font-size: 11px; color: #7f8c8d;">
                        Fuera de zona postal
                    </div>
                </div>
            </div>
        `)
        .openOn(mymap);
}

function showSimplePopup(latlng, titulo, codigo) {
    const ws = encodeURIComponent(` ${codigo}\nGPS: ${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}`);
    
    const popup = L.popup({ className: 'simple-popup' })
        .setLatLng([latlng.lat + 0.0004, latlng.lng])
        .setContent(`
            <div style="text-align:center; padding: 10px;">
                <small>${titulo}</small><br>
                <div class="code-display" style="font-size: 14px;">${codigo}</div>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${latlng.lat},${latlng.lng}')"> MAPS</button>
                <button class="btn-ws" onclick="window.open('https://wa.me/?text=${ws}')"> WS</button>
            </div>
        `)
        .openOn(mymap);
    
    popup.on('remove', () => {
        selectionLayer.clearLayers();
    });
}

// ==================== CARGA DE DATOS ====================

// Cargar todas las capas como en tu c贸digo original
$.getJSON("estafetas.geojson", d => { 
    rawZonas = d; 
    L.geoJSON(d, {
        style: {color: "#2c3e50", weight: 1.5, fillOpacity: 0.05}
    }).addTo(zonasGeoLayer);
    updateGridAndLabels();
});

$.getJSON("estafetasl.geojson", d => {
    L.geoJSON(d, {style: {color: "#e74c3c", weight: 2}}).addTo(rutasLayer);
}).fail(() => console.log("No se encontr贸 estafetasl.geojson"));

$.getJSON("estafetasp.geojson", d => {
    L.geoJSON(d, {
        pointToLayer: (f, ll) => L.circleMarker(ll, {
            radius: 5, 
            color: "#27ae60", 
            fillColor: "#2ecc71", 
            fillOpacity: 1
        })
    }).addTo(estafetasPointsLayer);
}).fail(() => console.log("No se encontr贸 estafetasp.geojson"));

// ==================== BUSCADOR ====================

document.getElementById('search-btn').addEventListener('click', () => {
    const code = document.getElementById('search-input').value.trim().toUpperCase();
    if (!code || !rawZonas) return;
    
    // Por ahora, centrar en vista general
    mymap.setView([8.50, -80.0], 12);
    
    // Mostrar mensaje
    alert(`Buscando: ${code}\n(Decodificador en desarrollo)`);
});

// ==================== TODOS LOS CONTROLES ORIGINALES ====================

// GPS
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const c = L.DomUtil.create('div', 'leaflet-bar');
        const b = L.DomUtil.create('a', 'locate-button', c);
        b.innerHTML = '';
        b.title = "Ubicar mi posici贸n";
        L.DomEvent.on(b, 'click', e => { 
            L.DomEvent.stopPropagation(e); 
            mymap.locate({setView:true, maxZoom:18}); 
        });
        return c;
    }
});
mymap.addControl(new LocateControl());

// CONTROL DE CAPAS COMPLETO
L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "C贸digo postal": gridLayer,
    "Selecci贸n": selectionLayer,
    "Mi ubicaci贸n": userLocationLayer
}, {collapsed: false}).addTo(mymap);

// Toggle labels
$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

// Eventos
mymap.on('moveend zoomend', updateGridAndLabels);
mymap.on('zoomstart movestart', function() {
    selectionLayer.clearLayers();
});

// GPS
mymap.on('locationfound', function(e) {
    userLocationLayer.clearLayers();
    
    L.marker(e.latlng, {
        icon: L.divIcon({
            className: 'user-location-icon',
            html: '',
            iconSize: [30, 30]
        }),
        zIndexOffset: 1000
    }).addTo(userLocationLayer);
    
    L.circle(e.latlng, {
        radius: e.accuracy / 2,
        color: '#3498db',
        fillColor: '#3498db',
        fillOpacity: 0.1,
        weight: 1
    }).addTo(userLocationLayer);
});

// Inicializar
updateGridAndLabels();
</script>
</body>
</html>
