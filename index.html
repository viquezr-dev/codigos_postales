<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL PANAMÁ V3</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; }
        .map-title h1 { margin: 0; font-size: 20px; color: #1a2a6c; text-shadow: 0 0 5px white; background: rgba(255,255,255,0.7); padding: 5px 15px; border-radius: 20px; }
        
        .search-container { position: absolute; top: 70px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        input#search-input { border: none; padding: 8px; outline: none; width: 180px; text-transform: uppercase; }
        button#search-btn { background: #1a2a6c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        /* Watermarks Labels */
        .watermark-label { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 2px 2px 4px white; font-weight: bold; width: 60px!important; margin-left: -30px!important; }
        .label-macro { font-size: 16px; opacity: 0.8; }
        .label-micro { font-size: 11px; color: #e67e22!important; }
        
        .codigo-final { background: #1a2a6c; color: white; padding: 12px; border-radius: 8px; font-size: 20px; font-weight: bold; text-align: center; margin: 10px 0; letter-spacing: 2px; }
        .btn-nav { display: block; width: 100%; padding: 10px; background: #3498db; color: white; text-align: center; text-decoration: none; border-radius: 5px; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAMÁ</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="EJ: B4-H6K-2W">
    <button id="search-btn">BUSCAR</button>
</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
// ==============================================
// CONFIGURACIÓN (LÍMITES PANAMÁ)
// ==============================================
const PANAMA = {
    N: 10.0, S: 7.0, W: -83.1, E: -77.0
};

const CONFIG = {
    RES_MACRO: 0.1,    // Bloques ~11km
    RES_MICRO: 0.1 / 24, 
    RES_NANO: (0.1 / 24) / 25,
    ALPHABET: "23456789ABCDEFGHJKLMNPQRSTVWXYZ", // 30 Caracteres exactos
    MAX_Y_MACRO: 30, // (10-7)/0.1
    MAX_Y_MICRO: 24,
    MAX_Y_NANO: 25
};

const mymap = L.map('mapid').setView([8.5, -80.1], 8);
L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);

// ==============================================
// LÓGICA DE CODIFICACIÓN
// ==============================================

function toBase30(num, digits) {
    let res = "";
    let n = Math.abs(Math.floor(num));
    for (let i = 0; i < digits; i++) {
        let index = n % 30;
        res = CONFIG.ALPHABET[index] + res;
        n = Math.floor(n / 30);
    }
    return res;
}

function fromBase30(code) {
    let res = 0;
    for (let i = 0; i < code.length; i++) {
        res = res * 30 + CONFIG.ALPHABET.indexOf(code[i]);
    }
    return res;
}

function getPostalCode(lat, lng) {
    // Validar si está fuera de Panamá
    if (lat > PANAMA.N || lat < PANAMA.S || lng < PANAMA.W || lng > PANAMA.E) return null;

    let mx = Math.floor((lng - PANAMA.W) / CONFIG.RES_MACRO);
    let my = Math.floor((PANAMA.N - lat) / CONFIG.RES_MACRO);
    let macroID = (mx * CONFIG.MAX_Y_MACRO) + my;

    let microX = Math.floor(((lng - PANAMA.W) % CONFIG.RES_MACRO) / CONFIG.RES_MICRO);
    let microY = Math.floor(((PANAMA.N - lat) % CONFIG.RES_MACRO) / CONFIG.RES_MICRO);
    let microID = (microX * CONFIG.MAX_Y_MICRO) + microY;

    let nanoX = Math.floor((((lng - PANAMA.W) % CONFIG.RES_MACRO) % CONFIG.RES_MICRO) / CONFIG.RES_NANO);
    let nanoY = Math.floor((((PANAMA.N - lat) % CONFIG.RES_MACRO) % CONFIG.RES_MICRO) / CONFIG.RES_NANO);
    let nanoID = (nanoX * CONFIG.MAX_Y_NANO) + nanoY;

    return {
        full: `${toBase30(macroID, 2)}-${toBase30(microID, 3)}-${toBase30(nanoID, 2)}`,
        macro: toBase30(macroID, 2),
        micro: toBase30(microID, 3)
    };
}

// ==============================================
// RENDERIZADO DINÁMICO
// ==============================================

function drawGrid() {
    const z = mymap.getZoom();
    gridLayer.clearLayers();
    labelLayer.clearLayers();

    if (z < 10) return;

    const b = mymap.getBounds();
    const sLat = Math.min(b.getNorth(), PANAMA.N);
    const eLat = Math.max(b.getSouth(), PANAMA.S);
    const sLng = Math.max(b.getWest(), PANAMA.W);
    const eLng = Math.min(b.getEast(), PANAMA.E);

    let step = (z >= 14) ? CONFIG.RES_MICRO : CONFIG.RES_MACRO;

    for (let lo = sLng; lo < eLng; lo += step) {
        for (let la = eLat; la < sLat; la += step) {
            let info = getPostalCode(la + step/2, lo + step/2);
            if (!info) continue;

            L.rectangle([[la, lo], [la + step, lo + step]], {
                color: z >= 14 ? '#e67e22' : '#1a73e8',
                weight: 0.5, fill: false
            }).addTo(gridLayer);

            // Watermarks por nivel de zoom
            if (z >= 11 && z < 14) {
                L.marker([la + step/2, lo + step/2], {
                    icon: L.divIcon({ className: 'watermark-label label-macro', html: info.macro })
                }).addTo(labelLayer);
            } else if (z >= 15 && z < 18) {
                L.marker([la + step/2, lo + step/2], {
                    icon: L.divIcon({ className: 'watermark-label label-micro', html: info.micro })
                }).addTo(labelLayer);
            }
        }
    }
}

// ==============================================
// EVENTOS E INTERACCIÓN
// ==============================================

mymap.on('click', function(e) {
    const info = getPostalCode(e.latlng.lat, e.latlng.lng);
    if (!info) return;

    selectionLayer.clearLayers();
    const r = CONFIG.RES_NANO;
    const snapLat = PANAMA.N - Math.floor((PANAMA.N - e.latlng.lat) / r) * r;
    const snapLng = PANAMA.W + Math.floor((e.latlng.lng - PANAMA.W) / r) * r;

    L.rectangle([[snapLat, snapLng], [snapLat - r, snapLng + r]], {
        color: 'red', weight: 2, fillOpacity: 0.4
    }).addTo(selectionLayer);

    L.popup()
        .setLatLng(e.latlng)
        .setContent(`
            <div style="text-align:center; min-width:200px">
                <small>UBICACIÓN POSTAL</small>
                <div class="codigo-final">${info.full}</div>
                <small>GPS: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}</small>
                <a class="btn-nav" href="https://www.google.com/maps/dir/?api=1&destination=${e.latlng.lat},${e.latlng.lng}" target="_blank">CÓMO LLEGAR</a>
            </div>
        `).openOn(mymap);
});

$('#search-btn').click(function() {
    const val = $('#search-input').val().toUpperCase().replace(/\s/g, '');
    const parts = val.split('-');
    if (parts.length !== 3) { alert("Formato requerido: XX-XXX-XX"); return; }

    try {
        let mID = fromBase30(parts[0]);
        let mx = Math.floor(mID / CONFIG.MAX_Y_MACRO);
        let my = mID % CONFIG.MAX_Y_MACRO;

        let miID = fromBase30(parts[1]);
        let mix = Math.floor(miID / CONFIG.MAX_Y_MICRO);
        let miy = miID % CONFIG.MAX_Y_MICRO;

        let nID = fromBase30(parts[2]);
        let nx = Math.floor(nID / CONFIG.MAX_Y_NANO);
        let ny = nID % CONFIG.MAX_Y_NANO;

        const lat = PANAMA.N - (my * CONFIG.RES_MACRO) - (miy * CONFIG.RES_MICRO) - (ny * CONFIG.RES_NANO);
        const lng = PANAMA.W + (mx * CONFIG.RES_MACRO) + (mix * CONFIG.RES_MICRO) + (nx * CONFIG.RES_NANO);

        mymap.setView([lat, lng], 18);
        L.marker([lat, lng]).addTo(selectionLayer).bindPopup("Código: " + val).openPopup();
    } catch(e) {
        alert("Código no reconocido.");
    }
});

mymap.on('moveend', drawGrid);
drawGrid();

</script>
</body>
</html>
