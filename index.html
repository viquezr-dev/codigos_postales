<!DOCTYPE html>
<html lang="es">
<head>
    <title>SISTEMAS POSTALES DE PANAM√Å (COTEL)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; background: #ddd; }
        
        /* Buscador Superior */
        .search-container {
            position: absolute; top: 10px; right: 10px; z-index: 5000; display: flex; gap: 5px; 
            background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px;
        }
        #search-input { flex: 1; border: 1px solid #ccc; padding: 5px; outline: none; font-family: monospace; font-size: 14px; text-transform: uppercase; border-radius: 4px; }
        #search-btn { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        
        .leaflet-top.leaflet-right { margin-top: 70px !important; }
        
        /* Etiquetas de Cuadr√≠cula (Watermarks) */
        .leaflet-tooltip.watermark-tooltip { background: transparent!important; border: none!important; box-shadow: none!important; color: rgba(0,0,0,0.5); font-weight: bold; font-family: monospace; text-shadow: 1px 1px 0px white; pointer-events: none; }
        .label-macro { color: #1a73e8!important; font-size: 15px; }
        .label-micro { color: #e67e22!important; font-size: 11px; }

        /* Estilo de Popups */
        .popup-header { font-weight: bold; display: block; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 3px; text-align: center; font-size: 11px; text-transform: uppercase; color: #666; }
        .codigo-final { background: #1a2a6c; color: white; padding: 12px; border-radius: 6px; font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 8px; border: 2px solid #f1c40f; }
        .btn-container { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
        .btn-maps { background: #4285F4; color: white !important; padding: 8px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: bold; }
        .btn-ws { background: #25D366; color: white !important; padding: 8px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: bold; }
        .btn-cercana { background: #003366; color: white !important; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; width: 100%; margin-top: 5px; }
        
        /* Telemetr√≠a */
        .distancia-label { background: #e74c3c; color: white; border: none; font-weight: bold; border-radius: 10px; padding: 2px 8px; font-size: 12px; }
        .locate-button { position: absolute; bottom: 30px; left: 10px; z-index: 1000; background: white; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .inv { background: none; border: none; }

        /* T√≠tulos */
        .map-title { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: none; text-align: center; pointer-events: none; width: 100%; }
        .map-title h1 { margin: 0; font-size: 22px; color: #1a2a6c; text-transform: uppercase; font-weight: 900; letter-spacing: 1px; text-shadow: 2px 2px 0px #fff, -1px -1px 0px #fff, 1px -1px 0px #fff, -1px 1px 0px #fff; }
        .map-title span { font-size: 11px; color: #333; display: block; font-weight: bold; margin-top: -2px; text-shadow: 1px 1px 0px #fff; }
    </style>
</head>
<body>

<div class="map-title">
    <h1>SISTEMAS POSTALES DE PANAM√Å</h1>
    <span>DIRECCI√ìN GENERAL DE CORREOS Y TEL√âGRAFOS (COTEL)</span>
</div>

<div class="search-container">
    <input type="text" id="search-input" placeholder="C√ìDIGO POSTAL..." maxlength="12">
    <button id="search-btn">IR</button>
</div>

<button class="locate-button" title="Mi Ubicaci√≥n" onclick="findMe()">üß≠</button>
<div id="mapid"></div>

<script>
// Configuraci√≥n del Sistema de Rejilla Global
const ORIGIN = { lat: 10.0, lng: -83.0 };
const PARAMS = {
    RES_MACRO: 0.143, 
    RES_MICRO: 0.143/24, 
    RES_NANO: (0.143/24)/25, 
    RES_PICO: ((0.143/24)/25)/8, 
    ALFA: "23456789ABCDEFGHJKLMNPQRSTVWXYZ", 
    MACRO_X_COUNT: Math.ceil((77.0 - 83.0) / -0.143)
};

// Inicializaci√≥n del Mapa
const mymap = L.map('mapid', { zoomSnap: 0.1, zoomControl: false, maxZoom: 22 }).setView([8.5, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    maxZoom: 22, 
    maxNativeZoom: 19,
    attribution: 'COTEL Panam√°'
}).addTo(mymap);

L.control.zoom({ position: 'bottomright' }).addTo(mymap);

// Capas de Datos
const layerZonas = L.geoJSON(null, { 
    style: { color: "#333", weight: 1.5, fillOpacity: 0.1, fillColor: "#3498db" },
    onEachFeature: (f, l) => {
        l.on({
            mouseover: (e) => { e.target.setStyle({ weight: 3, color: '#f1c40f', fillOpacity: 0.3 }); },
            mouseout: (e) => { layerZonas.resetStyle(e.target); },
            click: (e) => { seleccionar(e.latlng.lat, e.latlng.lng, f.properties.VM_LEVEL); L.DomEvent.stopPropagation(e); }
        });
    }
}).addTo(mymap);

const layerMacro = L.layerGroup().addTo(mymap);
const layerMicro = L.layerGroup().addTo(mymap);
const layerNano = L.layerGroup().addTo(mymap);
const layerRutas = L.layerGroup().addTo(mymap);
const layerEstafetas = L.layerGroup().addTo(mymap);
const layerMiUbicacion = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const distanceLayer = L.layerGroup().addTo(mymap);

// CARGA DE GEOJSON EXTERNOS (Campos Auditados: RUTA y ESTAF_NAME)
fetch('estafetas.geojson').then(r => r.json()).then(data => layerZonas.addData(data));

fetch('estafetasl.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, {
        style: { color: 'red', weight: 3, opacity: 0.7 },
        onEachFeature: (f, l) => { 
            l.bindPopup(`<b>RUTA:</b> ${f.properties.RUTA || 'SIN IDENTIFICAR'}`); 
        }
    }).addTo(layerRutas);
});

fetch('estafetasp.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, {
        pointToLayer: (f, ll) => L.circleMarker(ll, { radius: 7, fillColor: '#27ae60', color: '#fff', weight: 2, fillOpacity: 1 }),
        onEachFeature: (f, l) => { 
            l.bindPopup(`<b>ESTAFETA:</b> ${f.properties.ESTAF_NAME || 'SIN NOMBRE'}`); 
        }
    }).addTo(layerEstafetas);
});

// L√≥gica de Codificaci√≥n
function encode(num, len) {
    let s = ""; let n = Math.abs(Math.floor(num));
    for (let i = 0; i < len; i++) { s = PARAMS.ALFA[n % 30] + s; n = Math.floor(n / 30); }
    return s;
}

function getGridInfo(lat, lng) {
    const totalPicoX = Math.floor(((lng - ORIGIN.lng) / PARAMS.RES_PICO) + 0.00001);
    const totalPicoY = Math.floor(((ORIGIN.lat - lat) / PARAMS.RES_PICO) + 0.00001);
    const totalNanoX = Math.floor(totalPicoX / 8);
    const totalNanoY = Math.floor(totalPicoY / 8);
    const mx = Math.floor(totalNanoX / (24 * 25)), my = Math.floor(totalNanoY / (24 * 25));
    const microX = Math.floor((totalNanoX % (24 * 25)) / 25), microY = Math.floor((totalNanoY % (24 * 25)) / 25);
    const nanoX = totalNanoX % 25, nanoY = totalNanoY % 25;
    const picoX = totalPicoX % 8, picoY = totalPicoY % 8;
    return { macro: encode((my * PARAMS.MACRO_X_COUNT) + mx, 2), micro: encode((microY * 24) + microX, 2), nano: encode((nanoY * 25) + nanoX, 2), pico: encode((picoY * 8) + picoX, 2) };
}

// Acci√≥n de Clic y Selecci√≥n
function seleccionar(lat, lng, forcedZonaID = null) {
    selectionLayer.clearLayers();
    distanceLayer.clearLayers();
    const z = mymap.getZoom();
    
    let zonaID = forcedZonaID;
    if (!zonaID) {
        layerZonas.eachLayer(layer => {
            if (layer instanceof L.Polygon && layer.getBounds().contains(L.latLng(lat, lng))) {
                zonaID = layer.feature.properties.VM_LEVEL;
            }
        });
    }

    // Validaci√≥n de √Årea No Definida
    if (!zonaID) {
        L.marker([lat, lng], { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-black.png', iconSize: [20, 32] }) })
        .addTo(selectionLayer)
        .bindPopup(`
            <span class="popup-header">‚ö†Ô∏è √ÅREA NO DEFINIDA</span>
            <div style="text-align:center; padding:10px;">Centro de cuadr√≠cula fuera de l√≠mites territoriales o zona no mapeada.</div>
        `).openPopup();
        return;
    }

    const res = getGridInfo(lat, lng);
    let titulo = "", codigoFinal = "", drawBox = false;

    // Jerarqu√≠a de C√≥digos
    if (z < 13) {
        titulo = "ZONA POSTAL";
        codigoFinal = zonaID;
    } else {
        drawBox = true; 
        if (z < 16.5) {
            titulo = "√ÅREA MACRO/MICRO";
            codigoFinal = `${zonaID}-${res.macro}${res.micro}`;
        } else if (z < 18) {
            titulo = "C√ìDIGO NANO (26m)";
            codigoFinal = `${zonaID}-${res.macro}${res.micro}${res.nano}`;
        } else {
            titulo = "PUNTO EXACTO (3m)";
            let zonaLimpia = zonaID.toString().charAt(0) + zonaID.toString().substring(3);
            codigoFinal = `${zonaLimpia}${res.macro}-${res.micro}${res.nano}${res.pico}`;
        }
    }

    // Dibujo de Cuadro de Selecci√≥n
    if (drawBox) {
        const step = (z >= 18) ? PARAMS.RES_PICO : (z >= 16.5) ? PARAMS.RES_NANO : PARAMS.RES_MICRO;
        const idxX = Math.floor(((lng - ORIGIN.lng) / step) + 0.00001);
        const idxY = Math.floor(((ORIGIN.lat - lat) / step) + 0.00001);
        const snapLng = ORIGIN.lng + (idxX * step), snapLat = ORIGIN.lat - (idxY * step);
        L.rectangle([[snapLat, snapLng], [snapLat - step, snapLng + step]], { color: '#e74c3c', weight: 2, fillOpacity: 0.3, interactive: false }).addTo(selectionLayer);
    }

    // Marker de Selecci√≥n
    L.marker([lat, lng], { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [20, 32], iconAnchor: [10, 32] }) })
     .addTo(selectionLayer)
     .bindPopup(`
        <span class="popup-header">${titulo}</span>
        <div class="codigo-final">${codigoFinal}</div>
        <div class="btn-container">
            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn-maps">üìç MAPS</a>
            <a href="https://wa.me/?text=Mi+Direcci√≥n+Postal:+${codigoFinal}" target="_blank" class="btn-ws">üí¨ WS</a>
            <button onclick="buscarEstafetaCercana(${lat}, ${lng})" class="btn-cercana">üìç ESTAFETA CERCANA</button>
        </div>
     `, { offset: L.point(0, -45) }).openPopup();
}

// Telemetr√≠a de Estafeta Cercana
function buscarEstafetaCercana(lat, lng) {
    distanceLayer.clearLayers();
    const userPt = L.latLng(lat, lng);
    let cercana = null, dMin = Infinity;

    layerEstafetas.eachLayer(lGroup => {
        lGroup.eachLayer(l => {
            const pt = l.getLatLng();
            const d = userPt.distanceTo(pt);
            if (d < dMin) { dMin = d; cercana = l; }
        });
    });

    if (cercana) {
        const estPt = cercana.getLatLng();
        const texto = dMin > 1000 ? (dMin/1000).toFixed(2) + " km" : Math.round(dMin) + " m";
        const line = L.polyline([userPt, estPt], { color: '#c0392b', weight: 4, dashArray: '8, 8' }).addTo(distanceLayer);
        L.marker(line.getCenter(), { icon: L.divIcon({ className: 'inv' }) }).bindTooltip(texto, { permanent: true, direction: 'center', className: 'distancia-label' }).addTo(distanceLayer);
        mymap.fitBounds(line.getBounds(), { padding: [100, 100] });
        cercana.openPopup();
    }
}

// Renderizado de Cuadr√≠cula Din√°mica
function render() {
    layerMacro.clearLayers(); layerMicro.clearLayers(); layerNano.clearLayers();
    const z = mymap.getZoom(), b = mymap.getBounds();
    const draw = (step, layer, labelClass, color, weight, opacity, maxRects) => {
        let sIdxX = Math.floor((b.getWest() - ORIGIN.lng) / step), sIdxY = Math.floor((ORIGIN.lat - b.getNorth()) / step);
        let sLng = ORIGIN.lng + (sIdxX * step), sLat = ORIGIN.lat - (sIdxY * step);
        let count = 0;
        for (let lo = sLng; lo < b.getEast() + step; lo += step) {
            for (let la = sLat; la > b.getSouth() - step; la -= step) {
                if (count++ > maxRects) return;
                const info = getGridInfo(la - step/2, lo + step/2);
                L.rectangle([[la, lo], [la - step, lo + step]], { color: color, weight: weight, fill: false, opacity: opacity, interactive: false }).addTo(layer);
                if (labelClass && ((labelClass==='label-macro' && z < 13) || (labelClass==='label-micro' && z >= 13 && z < 16.5))) {
                    const txt = labelClass === 'label-macro' ? info.macro : info.micro;
                    L.marker([la - step/2, lo + step/2], { icon: L.divIcon({className: 'inv'}) }).bindTooltip(txt, { permanent: true, direction: 'center', className: `watermark-tooltip ${labelClass}` }).addTo(layer);
                }
            }
        }
    };
    if (z >= 9) draw(PARAMS.RES_MACRO, layerMacro, 'label-macro', '#1a73e8', 1.5, 0.2, 500);
    if (z >= 13) draw(PARAMS.RES_MICRO, layerMicro, 'label-micro', '#e67e22', 1, 0.2, 800);
    if (z >= 16.5) draw(PARAMS.RES_NANO, layerNano, '', '#2c3e50', 0.5, 0.2, 1500);
}

// Geoposicionamiento
function findMe() { mymap.locate({setView: true, maxZoom: 19}); }
mymap.on('locationfound', (e) => { 
    layerMiUbicacion.clearLayers(); 
    L.circleMarker(e.latlng, {radius: 9, color: 'white', fillColor: '#1a73e8', fillOpacity: 1, weight: 3}).addTo(layerMiUbicacion); 
    seleccionar(e.latlng.lat, e.latlng.lng); 
});

// Eventos
mymap.on('click', (e) => seleccionar(e.latlng.lat, e.latlng.lng));
mymap.on('moveend', render);

// Control de Capas
L.control.layers(null, { 
    "üî≤ Zonas": layerZonas, 
    "üü¶ Cuadr√≠cula": layerMacro, 
    "‚¨õ Cuadros (26m)": layerNano, 
    "üõ£Ô∏è Rutas": layerRutas, 
    "üìç Estafetas": layerEstafetas, 
    "üîµ Mi Ubicaci√≥n": layerMiUbicacion 
}, { collapsed: false }).addTo(mymap);

render();
</script>
</body>
</html>
