<!DOCTYPE html>
<html lang="es">
<head>
    <title>SISTEMA POSTAL PANAMÁ - OSM V11</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; background: #ddd; }
        
        /* Buscador Superior */
        .search-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 5000; display: flex; gap: 5px; background: white;
            padding: 8px; border-radius: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 90%; max-width: 450px;
        }
        #search-input { flex: 1; border: none; padding: 8px 15px; outline: none; font-family: monospace; font-size: 16px; text-transform: uppercase; }
        #search-btn { background: #e74c3c; color: white; border: none; padding: 8px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; }
        
        /* Estilos de Etiquetas */
        .leaflet-tooltip.watermark-tooltip { background: transparent!important; border: none!important; box-shadow: none!important; color: rgba(0,0,0,0.5); font-weight: bold; font-family: monospace; text-shadow: 1px 1px 0px white; }
        .label-macro { color: #1a73e8!important; font-size: 15px; }
        .label-micro { color: #e67e22!important; font-size: 11px; }
        .nano-selection-label { background: transparent!important; border: none!important; color: #000!important; font-weight: 900; font-family: monospace; font-size: 14px; text-shadow: 1px 1px 0px white; }
        
        /* Estilo del Popup con X de cierre */
        .codigo-final { 
            background: #1a2a6c; color: white; padding: 12px; border-radius: 6px; 
            font-size: 18px; font-weight: bold; text-align: center; margin-top: 5px;
        }
    </style>
</head>
<body>

<div class="search-container">
    <input type="text" id="search-input" placeholder="BUSCAR XXX-XXX-XX" maxlength="11">
    <button id="search-btn">BUSCAR</button>
</div>

<div id="mapid"></div>

<script>
const ORIGIN = { lat: 10.0, lng: -83.0 };
const PANAMA_LIMITS = { N: 10.0, S: 7.0, W: -83.0, E: -77.0 };
const PARAMS = {
    RES_MACRO: 0.1, RES_MICRO: 0.1 / 24, RES_NANO: (0.1 / 24) / 25,
    ALFA: "23456789ABCDEFGHJKLMNPQRSTVWXYZ",
    MAX_Y_GLOBAL: 200 
};

// Mapa con OSM
const mymap = L.map('mapid', { 
    zoomControl: false, 
    zoomSnap: 0.1,
    maxBounds: [[6.5, -83.5], [10.5, -76.5]],
    maxBoundsViscosity: 1.0 
}).setView([8.5, -80.0], 8);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(mymap);

const layerMacro = L.layerGroup().addTo(mymap);
const layerMicro = L.layerGroup().addTo(mymap);
const layerNano = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);

// --- LÓGICA DE CODIFICACIÓN ---
function encode(num, len) {
    let s = ""; let n = Math.abs(Math.floor(num));
    for (let i = 0; i < len; i++) { s = PARAMS.ALFA[n % 30] + s; n = Math.floor(n / 30); }
    return s;
}

function decode(s) {
    let n = 0;
    for (let i = 0; i < s.length; i++) {
        let charIndex = PARAMS.ALFA.indexOf(s[i].toUpperCase());
        if (charIndex === -1) throw new Error();
        n = n * 30 + charIndex;
    }
    return n;
}

function getSnappedCoords(lat, lng, step) {
    const snapLng = Math.floor((lng - ORIGIN.lng) / step) * step + ORIGIN.lng;
    const snapLat = ORIGIN.lat - Math.ceil((ORIGIN.lat - lat) / step) * step;
    return { lat: snapLat, lng: snapLng };
}

function getInfo(lat, lng) {
    if (lat > PANAMA_LIMITS.N || lat < PANAMA_LIMITS.S || lng < PANAMA_LIMITS.W || lng > PANAMA_LIMITS.E) return null;
    let mx = Math.floor((lng - ORIGIN.lng) / PARAMS.RES_MACRO);
    let my = Math.floor((ORIGIN.lat - lat) / PARAMS.RES_MACRO);
    let macroID = (mx * PARAMS.MAX_Y_GLOBAL) + my;
    let microX = Math.floor(((lng - ORIGIN.lng) % PARAMS.RES_MACRO) / PARAMS.RES_MICRO);
    let microY = Math.floor(((ORIGIN.lat - lat) % PARAMS.RES_MACRO) / PARAMS.RES_MICRO);
    let microID = (microX * 24) + microY;
    let n_rem_x = ((lng - ORIGIN.lng) % PARAMS.RES_MACRO) % PARAMS.RES_MICRO;
    let n_rem_y = ((ORIGIN.lat - lat) % PARAMS.RES_MACRO) % PARAMS.RES_MICRO;
    let nanoX = Math.floor(n_rem_x / PARAMS.RES_NANO);
    let nanoY = Math.floor(n_rem_y / PARAMS.RES_NANO);
    let nanoID = (nanoX * 25) + nanoY;
    return { macro: encode(macroID, 3), micro: encode(microID, 3), nano: encode(nanoID, 2) };
}

// --- RENDER ---
function render() {
    layerMacro.clearLayers(); layerMicro.clearLayers(); layerNano.clearLayers();
    const z = mymap.getZoom();
    if (z >= 10) drawGridLevel(PARAMS.RES_MACRO, layerMacro, 'label-macro', 2.5, '#1a73e8', 0.4);
    if (z >= 14) drawGridLevel(PARAMS.RES_MICRO, layerMicro, 'label-micro', 1.2, '#e67e22', 0.25);
    if (z >= 17.5) drawGridLevel(PARAMS.RES_NANO, layerNano, '', 0.5, '#2c3e50', 0.15);
}

function drawGridLevel(step, layer, labelClass, weight, color, opacity) {
    const b = mymap.getBounds(); const z = mymap.getZoom();
    let start = getSnappedCoords(b.getSouth() - step, b.getWest() - step, step);
    let count = 0;
    for (let lo = start.lng; lo < b.getEast() + step && lo < PANAMA_LIMITS.E; lo += step) {
        if (lo < PANAMA_LIMITS.W) continue;
        for (let la = start.lat; la < b.getNorth() + step && la < PANAMA_LIMITS.N; la += step) {
            if (la < PANAMA_LIMITS.S) continue;
            if (count++ > 1200) return;
            let data = getInfo(la + step/2, lo + step/2);
            if (!data) continue;
            L.rectangle([[la, lo], [la + step, lo + step]], { color: color, weight: weight, fill: false, opacity: opacity, interactive: false }).addTo(layer);
            if (labelClass !== '') {
                let showText = (labelClass === 'label-macro' && z < 14) || (labelClass === 'label-micro' && z >= 14 && z < 17.5);
                if (showText) {
                    let txt = (labelClass === 'label-macro') ? data.macro : data.micro;
                    L.marker([la + step/2, lo + step/2], { icon: L.divIcon({className: 'inv'}) }).bindTooltip(txt, { permanent: true, direction: 'center', className: `watermark-tooltip ${labelClass}` }).addTo(layer);
                }
            }
        }
    }
}

// --- SELECCIÓN Y PIN ---
function seleccionarCuadro(lat, lng, codFull, nanoPart) {
    selectionLayer.clearLayers();
    const step = PARAMS.RES_NANO; // Siempre marcamos nivel Nano en búsqueda
    const snap = getSnappedCoords(lat, lng, step);

    // Cuadro amarillo
    L.rectangle([[snap.lat, snap.lng], [snap.lat + step, snap.lng + step]], { 
        color: '#f1c40f', weight: 4, fillOpacity: 0.5, fillColor: '#f1c40f' 
    }).addTo(selectionLayer);
    
    // Texto Nano dentro
    L.marker([snap.lat + step/2, snap.lng + step/2], { icon: L.divIcon({className: 'inv'}) })
     .bindTooltip(nanoPart, { permanent: true, direction: 'center', className: 'nano-selection-label' })
     .addTo(selectionLayer);
    
    // Pin Rojo
    const redIcon = L.icon({ 
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
    });
    L.marker([snap.lat + step/2, snap.lng + step/2], { icon: redIcon }).addTo(selectionLayer);

    // Popup con botón de cerrar (X) habilitado por defecto
    L.popup({ offset: [0, -35], closeButton: true }) // closeButton: true pone la X
     .setLatLng([snap.lat + step, snap.lng + step/2])
     .setContent(`<div class="codigo-final">${codFull}</div>`)
     .openOn(mymap);
}

// --- BÚSQUEDA ---
document.getElementById('search-btn').addEventListener('click', () => {
    const input = document.getElementById('search-input').value.toUpperCase().replace(/\s/g, '');
    const parts = input.split('-');
    if (parts.length !== 3) { alert("Formato: XXX-XXX-XX"); return; }
    
    try {
        const idM = decode(parts[0]), idMi = decode(parts[1]), idN = decode(parts[2]);
        const mx = Math.floor(idM / PARAMS.MAX_Y_GLOBAL), my = idM % PARAMS.MAX_Y_GLOBAL;
        const mix = Math.floor(idMi / 24), miy = idMi % 24;
        const nax = Math.floor(idN / 25), nay = idN % 25;

        const tLng = ORIGIN.lng + (mx * PARAMS.RES_MACRO) + (mix * PARAMS.RES_MICRO) + (nax * PARAMS.RES_NANO) + (PARAMS.RES_NANO/2);
        const tLat = ORIGIN.lat - (my * PARAMS.RES_MACRO) - (miy * PARAMS.RES_MICRO) - (nay * PARAMS.RES_NANO) - (PARAMS.RES_NANO/2);

        if (tLat > PANAMA_LIMITS.N || tLat < PANAMA_LIMITS.S || tLng < PANAMA_LIMITS.W || tLng > PANAMA_LIMITS.E) {
            alert("Fuera de Panamá"); return;
        }

        // Primero volamos, luego marcamos para evitar que el pin se pierda
        mymap.flyTo([tLat, tLng], 18);
        mymap.once('moveend', () => {
            seleccionarCuadro(tLat, tLng, input, parts[2]);
        });
    } catch(e) { alert("Código no reconocido"); }
});

mymap.on('click', (e) => {
    const res = getInfo(e.latlng.lat, e.latlng.lng);
    if (res) seleccionarCuadro(e.latlng.lat, e.latlng.lng, `${res.macro}-${res.micro}-${res.nano}`, res.nano);
});

mymap.on('moveend', render);
render();
</script>
<style>.inv { background: none; border: none; }</style>
</body>
</html>
