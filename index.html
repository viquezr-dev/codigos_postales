<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM츼</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 250px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .leaflet-top.leaflet-right { top: 80px !important; }
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; font-weight: bold; }
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; }
        .micro-label-fixed { background: none!important; border:none!important; color: #3498db!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 9px; }
        .nano-label-fixed { background: none!important; border:none!important; color: #2980b9!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 8px; }
        .nano-selection-label { background: none!important; border: none!important; text-align: center; pointer-events: none!important; }
        .micro-selection-label { background: none!important; border: none!important; text-align: center; pointer-events: none!important; }
        .btn-nav, .btn-ws { display: inline-block; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin: 2px; border:none; cursor: pointer; }
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
        .locate-button { width: 30px; height: 30px; line-height: 30px; text-align: center; display: block; text-decoration: none; color: black; background: white; font-size: 18px; cursor: pointer; }
        .user-location-icon { text-align: center; font-size: 20px; }
        .highlighted-polygon { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { fill-opacity: 0.3; }
            50% { fill-opacity: 0.7; }
            100% { fill-opacity: 0.3; }
        }
        .warning-popup .leaflet-popup-content-wrapper {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }
        .warning-popup .leaflet-popup-tip {
            background: #ffc107;
        }
        .code-display {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 1px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 2px solid #3498db;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM츼</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: K4299-KF952-J31">
    <button id="search-btn">IR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
// ==================== CONFIGURACI칍N ====================
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// Capas
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawZonas = null;
let labelsEnabled = true;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
const NANO_RES = 25;

// ==================== BOUNDING BOX DE PANAM츼 ====================
// Coordenadas extremas de Panam치 (basado en tus datos)
const PANAMA_BOUNDS = {
    minLng: -83.0,  // Oeste
    maxLng: -77.0,  // Este  
    minLat: 7.0,    // Sur
    maxLat: 9.8     // Norte
};

// ==================== FUNCIONES DE C칍DIGO ====================

function getMicroCodeFromIndices(ix, iy, fid) {
    const baseCode = `${ALFABETO[ix]}${ALFABETO[iy]}${ix % 10}${iy % 10}`;
    const factor = (Math.floor((ix + iy) / 5) + (fid % 10)) % 10;
    return baseCode + factor;
}

function generateNanoCode(nix, niy, microIx, microIy, fid) {
    const salt = (microIx * 24 + microIy) * 1000 + fid;
    let hash = (nix * 15485863) ^ (niy * 2860486313) ^ (salt * 5915587277);
    hash = (hash * 2654435761) >>> 0;
    
    const letterIndex = hash % 24;
    const num1 = Math.floor((hash / 24) % 10);
    const num2 = Math.floor((hash / 240) % 10);
    
    return `${ALFABETO[letterIndex]}${num1}${num2}`;
}

// Convertir coordenadas a 칤ndices en la cuadr칤cula universal
function latLngToIndices(lat, lng) {
    // Posici칩n relativa en el bounding box de Panam치
    const relX = (lng - PANAMA_BOUNDS.minLng) / (PANAMA_BOUNDS.maxLng - PANAMA_BOUNDS.minLng);
    const relY = (lat - PANAMA_BOUNDS.minLat) / (PANAMA_BOUNDS.maxLat - PANAMA_BOUNDS.minLat);
    
    // Limitar entre 0 y 1
    const safeRelX = Math.max(0, Math.min(0.999999, relX));
    const safeRelY = Math.max(0, Math.min(0.999999, relY));
    
    // 칈ndices micro (0-23)
    const microIx = Math.floor(safeRelX * 24);
    const microIy = Math.floor(safeRelY * 24);
    
    // 칈ndices nano dentro de micro (0-24)
    const nix = Math.floor((safeRelX * 24 - microIx) * NANO_RES);
    const niy = Math.floor((safeRelY * 24 - microIy) * NANO_RES);
    
    return { microIx, microIy, nix, niy, relX: safeRelX, relY: safeRelY };
}

// Convertir 칤ndices a coordenadas de celda
function indicesToCellBounds(microIx, microIy, isNano = false, nix = 0, niy = 0) {
    let totalCells = 24;
    let cellSizeX = (PANAMA_BOUNDS.maxLng - PANAMA_BOUNDS.minLng) / totalCells;
    let cellSizeY = (PANAMA_BOUNDS.maxLat - PANAMA_BOUNDS.minLat) / totalCells;
    
    if (isNano) {
        totalCells *= NANO_RES;
        cellSizeX = (PANAMA_BOUNDS.maxLng - PANAMA_BOUNDS.minLng) / totalCells;
        cellSizeY = (PANAMA_BOUNDS.maxLat - PANAMA_BOUNDS.minLat) / totalCells;
        
        const nanoIx = microIx * NANO_RES + nix;
        const nanoIy = microIy * NANO_RES + niy;
        
        const west = PANAMA_BOUNDS.minLng + nanoIx * cellSizeX;
        const east = west + cellSizeX;
        const south = PANAMA_BOUNDS.minLat + nanoIy * cellSizeY;
        const north = south + cellSizeY;
        
        return [[south, west], [south, east], [north, east], [north, west]];
    } else {
        const west = PANAMA_BOUNDS.minLng + microIx * cellSizeX;
        const east = west + cellSizeX;
        const south = PANAMA_BOUNDS.minLat + microIy * cellSizeY;
        const north = south + cellSizeY;
        
        return [[south, west], [south, east], [north, east], [north, west]];
    }
}

// ==================== ACTUALIZAR GRID ====================

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    
    if (!rawZonas) return;
    
    const z = mymap.getZoom();
    const bounds = mymap.getBounds();
    
    // Dibujar grid de Panam치 (no por pol칤gono)
    if (z >= 14 && z <= 20) {
        const totalCells = 24;
        const cellSizeX = (PANAMA_BOUNDS.maxLng - PANAMA_BOUNDS.minLng) / totalCells;
        const cellSizeY = (PANAMA_BOUNDS.maxLat - PANAMA_BOUNDS.minLat) / totalCells;
        
        // Configurar estilo seg칰n zoom
        let weight, opacity, color;
        if (z >= 14 && z < 17) {
            weight = 1.5;
            opacity = 0.6;
            color = '#2980b9';
        } else {
            weight = 1.0;
            opacity = 0.5;
            color = '#3498db';
        }
        
        // Dibujar l칤neas verticales y horizontales
        for (let i = 0; i <= totalCells; i++) {
            const lng = PANAMA_BOUNDS.minLng + i * cellSizeX;
            const lat = PANAMA_BOUNDS.minLat + i * cellSizeY;
            
            // L칤nea vertical
            const vStart = [PANAMA_BOUNDS.minLat, lng];
            const vEnd = [PANAMA_BOUNDS.maxLat, lng];
            
            // L칤nea horizontal
            const hStart = [lat, PANAMA_BOUNDS.minLng];
            const hEnd = [lat, PANAMA_BOUNDS.maxLng];
            
            L.polyline([vStart, vEnd], {color, weight, opacity}).addTo(gridLayer);
            L.polyline([hStart, hEnd], {color, weight, opacity}).addTo(gridLayer);
        }
        
        // Mostrar labels micro en zoom 14-17
        if (z >= 14 && z < 17 && labelsEnabled) {
            for (let i = 0; i < totalCells; i++) {
                for (let j = 0; j < totalCells; j++) {
                    const centerLng = PANAMA_BOUNDS.minLng + (i + 0.5) * cellSizeX;
                    const centerLat = PANAMA_BOUNDS.minLat + (j + 0.5) * cellSizeY;
                    
                    // Verificar si el centro est치 dentro de alg칰n pol칤gono
                    const insidePolygon = leafletPip.pointInLayer(
                        [centerLng, centerLat], 
                        L.geoJSON(rawZonas)
                    ).length > 0;
                    
                    if (insidePolygon) {
                        // Buscar en qu칠 pol칤gono est치 para obtener fid
                        const polygons = leafletPip.pointInLayer([centerLng, centerLat], L.geoJSON(rawZonas));
                        if (polygons.length > 0) {
                            const fid = polygons[0].feature.properties.fid;
                            const microCode = getMicroCodeFromIndices(i, j, fid);
                            
                            L.marker([centerLat, centerLng], {
                                icon: L.divIcon({ 
                                    className: 'micro-label-fixed', 
                                    html: microCode, 
                                    iconSize: [45, 15] 
                                })
                            }).addTo(labelLayer);
                        }
                    }
                }
            }
        }
    }
    
    // Labels macro (VM_LEVEL) en zoom bajo
    if (z >= 9 && z < 14 && labelsEnabled) {
        rawZonas.features.forEach(feature => {
            const featureBounds = L.geoJSON(feature).getBounds();
            if (bounds.intersects(featureBounds)) {
                const center = featureBounds.getCenter();
                const vmLevel = feature.properties.VM_LEVEL;
                
                L.marker(center, {
                    icon: L.divIcon({ 
                        className: 'watermark-label-fixed', 
                        html: vmLevel, 
                        iconSize: [60, 20] 
                    })
                }).addTo(labelLayer);
            }
        });
    }
}

// ==================== EVENTO CLIC ====================

mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    
    if (!rawZonas) return;
    
    // Verificar si el clic est치 dentro de alg칰n pol칤gono
    const clickedFeatures = leafletPip.pointInLayer(
        [e.latlng.lng, e.latlng.lat], 
        L.geoJSON(rawZonas)
    );

    // FUERA DE POL칈GONOS = SIN C칍DIGO POSTAL
    if (clickedFeatures.length === 0) {
        const popupOffset = [0, -60];
        const popupLatLng = L.latLng(e.latlng.lat + 0.0004, e.latlng.lng);
        
        L.popup({offset: popupOffset, className: 'warning-popup'})
            .setLatLng(popupLatLng)
            .setContent(`
                <div style="text-align:center; padding: 10px;">
                    <div style="font-size: 16px; color: #e74c3c; margin-bottom: 5px;">
                        丘멆잺 츼REA NO ASIGNADA
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 15px;">
                        Esta ubicaci칩n no tiene c칩digo postal asignado
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">游늸 MAPS</button>
                        <button class="btn-ws" onclick="window.open('https://wa.me/?text=${encodeURIComponent(`游늸 Ubicaci칩n sin c칩digo postal\nGPS: ${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`)}')">游눫 WS</button>
                    </div>
                </div>
            `)
            .openOn(mymap);
        return;
    }

    // DENTRO DE POL칈GONO = GENERAR C칍DIGO
    const feature = clickedFeatures[0].feature;
    const vmLevel = feature.properties.VM_LEVEL;
    const fid = feature.properties.fid;
    
    let titulo = "ZONAS POSTALES";
    let finalCode = vmLevel;
    const z = mymap.getZoom();

    // Calcular 칤ndices en la cuadr칤cula universal
    const indices = latLngToIndices(e.latlng.lat, e.latlng.lng);
    
    if (z < 14) {
        // Nivel macro
        titulo = "ZONA POSTAL";
        L.geoJSON(feature, {
            style: {
                color: "#1a73e8", 
                weight: 4, 
                fillColor: "#1a73e8",
                fillOpacity: 0.3,
                className: 'highlighted-polygon'
            }
        }).addTo(selectionLayer);
        
    } else if (z >= 14 && z < 17) {
        // Nivel micro
        titulo = "츼REA POSTAL";
        const microCode = getMicroCodeFromIndices(indices.microIx, indices.microIy, fid);
        finalCode += `-${microCode}`;
        
        // Mostrar celda micro
        const microBounds = indicesToCellBounds(indices.microIx, indices.microIy);
        L.polygon(microBounds, {
            color: "#3498db", 
            weight: 3, 
            fillColor: "#3498db",
            fillOpacity: 0.5,
            className: 'highlighted-polygon'
        }).addTo(selectionLayer);
        
        // Etiqueta micro
        const center = [
            (microBounds[0][0] + microBounds[2][0]) / 2,
            (microBounds[0][1] + microBounds[2][1]) / 2
        ];
        
        L.marker(center, {
            icon: L.divIcon({ 
                className: 'micro-selection-label', 
                html: `<div style="background: white; color: #3498db; padding: 3px 6px; border-radius: 3px; border: 2px solid #3498db; font-weight: bold;">${microCode}</div>`, 
                iconSize: [50, 25],
                iconAnchor: [25, 12]
            }),
            zIndexOffset: 1000
        }).addTo(selectionLayer);
        
    } else {
        // Nivel nano
        titulo = "C칍DIGO POSTAL";
        const microCode = getMicroCodeFromIndices(indices.microIx, indices.microIy, fid);
        const nanoCode = generateNanoCode(indices.nix, indices.niy, indices.microIx, indices.microIy, fid);
        finalCode += `-${microCode}-${nanoCode}`;
        
        // Mostrar celda nano
        const nanoBounds = indicesToCellBounds(indices.microIx, indices.microIy, true, indices.nix, indices.niy);
        L.polygon(nanoBounds, {
            color: "#2980b9", 
            weight: 3, 
            fillColor: "#2980b9",
            fillOpacity: 0.5,
            className: 'highlighted-polygon'
        }).addTo(selectionLayer);
        
        // Etiqueta nano
        const center = [
            (nanoBounds[0][0] + nanoBounds[2][0]) / 2,
            (nanoBounds[0][1] + nanoBounds[2][1]) / 2
        ];
        
        L.marker(center, {
            icon: L.divIcon({ 
                className: 'nano-selection-label', 
                html: `<div style="background: white; color: #2980b9; padding: 2px 5px; border-radius: 3px; border: 2px solid #2980b9; font-weight: bold;">${nanoCode}</div>`, 
                iconSize: [45, 22],
                iconAnchor: [22, 11]
            }),
            zIndexOffset: 1000
        }).addTo(selectionLayer);
        
        // Borde micro para referencia
        const microBounds = indicesToCellBounds(indices.microIx, indices.microIy);
        L.polygon(microBounds, {
            color: "#3498db", 
            weight: 2, 
            fillColor: "transparent",
            dashArray: "5, 5",
            opacity: 0.4
        }).addTo(selectionLayer);
    }

    console.log(`C칩digo postal: ${finalCode}`);
    
    // Popup con informaci칩n
    const ws = encodeURIComponent(`游늸 Mi c칩digo postal: ${finalCode}\nGPS: ${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`);
    const popupOffset = [0, -60];
    const popupLatLng = L.latLng(e.latlng.lat + 0.0004, e.latlng.lng);
    
    const props = feature.properties;
    const areaKm2 = props.AREA ? (props.AREA / 1000000).toFixed(2) : "N/A";
    
    const popup = L.popup({offset: popupOffset})
        .setLatLng(popupLatLng)
        .setContent(`
            <div style="text-align:center;">
                <small>${titulo}</small><br>
                <div class="code-display">${finalCode}</div>
                <div style="font-size: 11px; color: #666; margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">
                    ${props.PROV_NOMB || 'Provincia'} | 츼rea: ${areaKm2} km
                </div>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">游늸 MAPS</button>
                <button class="btn-ws" onclick="window.open('https://wa.me/?text=${ws}')">游눫 WS</button>
            </div>
        `)
        .openOn(mymap);
    
    popup.on('remove', function() {
        selectionLayer.clearLayers();
    });
});

// ==================== CARGA DE DATOS ====================

$.getJSON("estafetas.geojson", d => { 
    rawZonas = d; 
    
    // A침adir pol칤gonos con estilo
    L.geoJSON(d, {
        style: function(feature) {
            return {
                color: feature.properties.fid % 2 === 0 ? "#2c3e50" : "#34495e",
                weight: 1.5,
                fillOpacity: 0.05,
                opacity: 0.8
            };
        },
        onEachFeature: function(feature, layer) {
            const props = feature.properties;
            layer.bindPopup(`
                <b>${props.VM_LEVEL}</b><br>
                Provincia: ${props.PROV_NOMB}<br>
                츼rea: ${props.AREA ? (props.AREA / 1000000).toFixed(2) + ' km' : 'N/A'}<br>
                Estafeta: ${props.ESTAF_NAME || 'Por definir'}
            `);
        }
    }).addTo(zonasGeoLayer);
    
    updateGridAndLabels();
});

// Cargar otros datos si existen
$.getJSON("estafetasl.geojson", d => {
    L.geoJSON(d, {style: {color: "#e74c3c", weight: 2}}).addTo(rutasLayer);
}).fail(() => console.log("No se encontr칩 estafetasl.geojson"));

$.getJSON("estafetasp.geojson", d => {
    L.geoJSON(d, {
        pointToLayer: (f, ll) => L.circleMarker(ll, {
            radius: 5, 
            color: "#27ae60", 
            fillColor: "#2ecc71", 
            fillOpacity: 1
        })
    }).addTo(estafetasPointsLayer);
}).fail(() => console.log("No se encontr칩 estafetasp.geojson"));

// ==================== BUSCADOR ====================

document.getElementById('search-btn').addEventListener('click', () => {
    const code = document.getElementById('search-input').value.trim().toUpperCase();
    if (!code || !rawZonas) return;
    
    const parts = code.split('-');
    const vmLevel = parts[0];
    
    // Buscar zona por VM_LEVEL
    let feature = rawZonas.features.find(f => f.properties.VM_LEVEL === vmLevel);
    
    if (feature) {
        selectionLayer.clearLayers();
        
        const bounds = L.geoJSON(feature).getBounds();
        const zoomLevel = parts.length > 2 ? 18 : parts.length > 1 ? 16 : 12;
        
        // Destacar pol칤gono
        L.geoJSON(feature, {
            style: {
                color: "#3498db", 
                weight: 3, 
                fillColor: "#3498db",
                fillOpacity: 0.3
            }
        }).addTo(selectionLayer);
        
        // Centrar y hacer zoom
        mymap.fitBounds(bounds, {padding: [50, 50]});
        if (zoomLevel > 12) {
            setTimeout(() => mymap.setZoom(zoomLevel), 300);
        }
    } else {
        alert("C칩digo postal no encontrado: " + code);
    }
});

// ==================== CONTROLES ====================

// GPS
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const c = L.DomUtil.create('div', 'leaflet-bar');
        const b = L.DomUtil.create('a', 'locate-button', c);
        b.innerHTML = '游꿢';
        b.title = "Ubicar mi posici칩n";
        L.DomEvent.on(b, 'click', e => { 
            L.DomEvent.stopPropagation(e); 
            mymap.locate({setView:true, maxZoom:18}); 
        });
        return c;
    }
});
mymap.addControl(new LocateControl());

// Control de capas
L.control.layers(null, {
    "Zonas Postales": zonasGeoLayer,
    "Cuadr칤cula": gridLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "Selecci칩n": selectionLayer,
    "Mi ubicaci칩n": userLocationLayer
}, {collapsed: false}).addTo(mymap);

// Toggle labels
$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

// Eventos
mymap.on('moveend zoomend', updateGridAndLabels);
mymap.on('zoomstart movestart', function() {
    selectionLayer.clearLayers();
});

// GPS
mymap.on('locationfound', function(e) {
    userLocationLayer.clearLayers();
    
    L.marker(e.latlng, {
        icon: L.divIcon({
            className: 'user-location-icon',
            html: '游늸',
            iconSize: [30, 30]
        }),
        zIndexOffset: 1000
    }).addTo(userLocationLayer);
});

// Inicializar
updateGridAndLabels();
</script>
</body>
</html>
