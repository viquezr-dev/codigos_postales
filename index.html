<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM√Å - SIN REPETICIONES</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        .map-title h2 { margin: 0; font-size: 12px; color: #2980b9; font-weight: normal; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        .leaflet-top.leaflet-right { top: 80px !important; }
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; font-weight: bold; }
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; }
        .micro-label-fixed { background: none!important; border:none!important; color: #3498db!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 9px; }
        .nano-label-fixed { background: none!important; border:none!important; color: #2980b9!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 8px; }
        .btn-nav, .btn-ws { display: inline-block; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin: 2px; border:none; cursor: pointer; }
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
        .locate-button { width: 30px; height: 30px; line-height: 30px; text-align: center; display: block; text-decoration: none; color: black; background: white; font-size: 18px; cursor: pointer; }
        .user-location-icon { text-align: center; font-size: 20px; }
        .highlighted-polygon { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { fill-opacity: 0.3; }
            50% { fill-opacity: 0.7; }
            100% { fill-opacity: 0.3; }
        }
        .warning-popup .leaflet-popup-content-wrapper {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }
        .warning-popup .leaflet-popup-tip {
            background: #ffc107;
        }
        .estafeta-popup .leaflet-popup-content-wrapper {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 8px;
        }
        .estafeta-popup .leaflet-popup-tip {
            background: #28a745;
        }
        .ruta-popup .leaflet-popup-content-wrapper {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 8px;
        }
        .ruta-popup .leaflet-popup-tip {
            background: #dc3545;
        }
        .zona-popup .leaflet-popup-content-wrapper {
            background: #e9ecef;
            border: 2px solid #6c757d;
            border-radius: 8px;
        }
        .zona-popup .leaflet-popup-tip {
            background: #6c757d;
        }
        .grid-macro { stroke-dasharray: none; }
        .grid-micro { stroke-dasharray: 5, 5; }
        .grid-nano { stroke-dasharray: 2, 3; }
        .nano-popup .leaflet-popup-content-wrapper {
            background: #e3f2fd;
            border: 2px solid #1976d2;
            border-radius: 8px;
            max-width: 240px;
        }
        .nano-popup .leaflet-popup-tip {
            background: #1976d2;
        }
        .codigo-final {
            background: #1976d2;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
            text-align: center;
            letter-spacing: 1px;
        }
        .codigo-completo {
            background: #f8f9fa;
            color: #495057;
            padding: 8px;
            border-radius: 5px;
            font-size: 13px;
            margin: 5px 0;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .nano-grid-line {
            pointer-events: none;
        }
        .grid-helper {
            pointer-events: none;
        }
        #unicidad-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            color: #2c3e50;
            z-index: 1000;
            border: 2px solid #27ae60;
            max-width: 320px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .unique-badge {
            background: #27ae60;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .watermark-label-fixed .leaflet-marker-icon {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            margin-left: -20px !important;
            margin-top: -10px !important;
        }
        
        .micro-label-fixed .leaflet-marker-icon {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            margin-left: -30px !important;
            margin-top: -7px !important;
        }
        
        .nano-label-fixed .leaflet-marker-icon {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            margin-left: -15px !important;
            margin-top: -6px !important;
        }
        
        .watermark-label-fixed div,
        .micro-label-fixed div,
        .nano-label-fixed div {
            text-align: center;
            width: 100%;
            font-weight: bold;
            text-shadow: 
                1px 1px 1px white,
                -1px -1px 1px white,
                1px -1px 1px white,
                -1px 1px 1px white;
        }
    </style>
</head>
<body>

<div class="map-title">
    <h1>SISTEMA POSTAL DE PANAM√Å</h1>
    <h2>Formato √∫nico: Zona-8D√≠gitos (Ej: E8399-A1B2C3D4)</h2>
</div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: E8399-A1B2C3D4">
    <button id="search-btn">BUSCAR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
// ==============================================
// CONFIGURACI√ìN DEL SISTEMA 0.1¬∞ - SIN REPETICIONES
// ==============================================
const GRID_CONFIG = {
    ORIGIN_LAT: 9.9,
    ORIGIN_LNG: -83.1,
    RES_MACRO: 0.1,
    RES_MICRO: 0.1 / 24,
    RES_NANO: 0.1 / 600,
    ALPHABET: "23456789BCDFGHJKLMNPQRSTVWXYZ",
    MACROS_X: 60,
    MACROS_Y: 27
};

// ==============================================
// INICIALIZACI√ìN DEL MAPA
// ==============================================
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// Capas
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawZonas = null;
let rutasData = null, estafetasData = null;
let labelsEnabled = true;

// ==============================================
// FUNCIONES BASE - SIN CAMBIOS
// ==============================================

// 1. Convertir coordenada ‚Üí √≠ndices
function coordenadaAIndices(lat, lng) {
    const { ORIGIN_LAT, ORIGIN_LNG, RES_MACRO, RES_MICRO, RES_NANO, MACROS_X, MACROS_Y } = GRID_CONFIG;
    
    if (lat > ORIGIN_LAT || lat < (ORIGIN_LAT - (MACROS_Y * RES_MACRO)) ||
        lng < ORIGIN_LNG || lng > (ORIGIN_LNG + (MACROS_X * RES_MACRO))) {
        return null;
    }
    
    const deltaLng = lng - ORIGIN_LNG;
    const deltaLat = ORIGIN_LAT - lat;
    
    const macroX = Math.floor(deltaLng / RES_MACRO);
    const macroY = Math.floor(deltaLat / RES_MACRO);
    
    const microX = Math.floor((deltaLng % RES_MACRO) / RES_MICRO);
    const microY = Math.floor((deltaLat % RES_MACRO) / RES_MICRO);
    
    const nanoX = Math.floor((((deltaLng % RES_MACRO) % RES_MICRO) / RES_NANO));
    const nanoY = Math.floor((((deltaLat % RES_MACRO) % RES_MICRO) / RES_NANO));
    
    return { 
        macroX: Math.min(macroX, MACROS_X - 1), 
        macroY: Math.min(macroY, MACROS_Y - 1),
        microX: Math.min(microX, 23), 
        microY: Math.min(microY, 23),
        nanoX: Math.min(nanoX, 24), 
        nanoY: Math.min(nanoY, 24)
    };
}

// 2. Convertir n√∫mero a base30 - MEJORADA
function toBase30(num, digits) {
    const { ALPHABET } = GRID_CONFIG;
    
    if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) {
        console.warn("N√∫mero inv√°lido para toBase30:", num);
        return "??".repeat(digits);
    }
    
    num = Math.abs(Math.floor(num));
    const maxVal = Math.pow(30, digits) - 1;
    if (num > maxVal) {
        num = num % maxVal;
    }
    
    let result = '';
    
    for (let i = 0; i < digits; i++) {
        const index = num % 30;
        
        if (index >= 0 && index < ALPHABET.length) {
            result = ALPHABET[index] + result;
        } else {
            result = ALPHABET[0] + result;
        }
        
        num = Math.floor(num / 30);
    }
    
    return result;
}

// ==============================================
// NUEVO: GENERAR C√ìDIGO POSTAL √öNICO (8 D√çGITOS)
// ==============================================

function generarCodigoPostalUnico(lat, lng, vmLevel) {
    const indices = coordenadaAIndices(lat, lng);
    if (!indices) return null;
    
    // 1. MACRO: Combinar macroX y macroY en un n√∫mero √∫nico
    // Rango: 0 a (60*27-1) = 0 a 1619
    const macroCombinado = indices.macroX * GRID_CONFIG.MACROS_Y + indices.macroY;
    const macroCode = toBase30(macroCombinado, 2); // 2 caracteres para 0-1619
    
    // 2. MICRO: Combinar microX y microY en un n√∫mero √∫nico
    // Rango: 0 a (24*24-1) = 0 a 575
    const microCombinado = indices.microX * 24 + indices.microY;
    const microCode = toBase30(microCombinado, 2); // 2 caracteres para 0-575
    
    // 3. NANO: Combinar nanoX y nanoY en un n√∫mero √∫nico
    // Rango: 0 a (25*25-1) = 0 a 624
    const nanoCombinado = indices.nanoX * 25 + indices.nanoY;
    const nanoCode = toBase30(nanoCombinado, 2); // 2 caracteres para 0-624
    
    // 4. VERIFICACI√ìN: A√±adir d√≠gito de checksum simple
    const totalCombinado = macroCombinado + microCombinado + nanoCombinado;
    const checksum = totalCombinado % 30;
    const checksumCode = GRID_CONFIG.ALPHABET[checksum];
    
    // 5. C√≥digo final: 8 caracteres (2+2+2+1 checksum + 1 separador)
    const panamaCode = macroCode + microCode + nanoCode + checksumCode;
    
    // C√≥digo postal completo
    return {
        panamaCode: panamaCode, // 7 caracteres
        codigoPostal: `${vmLevel || 'SINVM'}-${panamaCode}`, // Ej: E8399-A1B2C3D
        macroCode: macroCode,
        microCode: microCode,
        nanoCode: nanoCode,
        checksumCode: checksumCode,
        idUnico: macroCombinado * 1000000 + microCombinado * 1000 + nanoCombinado
    };
}

// ==============================================
// FUNCI√ìN PARA DECODIFICAR C√ìDIGO
// ==============================================

function decodificarCodigoPostal(codigoCompleto) {
    // Formato esperado: Zona-XXXXXXX (7 d√≠gitos)
    const partes = codigoCompleto.split('-');
    if (partes.length !== 2 || partes[1].length !== 7) {
        return { error: "Formato inv√°lido. Usa: Zona-7D√≠gitos" };
    }
    
    const zona = partes[0];
    const codigo = partes[1];
    
    // Extraer partes del c√≥digo
    const macroCode = codigo.substring(0, 2);
    const microCode = codigo.substring(2, 4);
    const nanoCode = codigo.substring(4, 6);
    const checksumCode = codigo.substring(6, 7);
    
    // Decodificar macro
    let macroCombinado = 0;
    for (let i = 0; i < 2; i++) {
        const char = macroCode.charAt(i);
        const index = GRID_CONFIG.ALPHABET.indexOf(char);
        if (index === -1) return { error: `Car√°cter inv√°lido en macro: ${char}` };
        macroCombinado = macroCombinado * 30 + index;
    }
    
    // Calcular macroX y macroY
    const macroX = Math.floor(macroCombinado / GRID_CONFIG.MACROS_Y);
    const macroY = macroCombinado % GRID_CONFIG.MACROS_Y;
    
    // Decodificar micro
    let microCombinado = 0;
    for (let i = 0; i < 2; i++) {
        const char = microCode.charAt(i);
        const index = GRID_CONFIG.ALPHABET.indexOf(char);
        if (index === -1) return { error: `Car√°cter inv√°lido en micro: ${char}` };
        microCombinado = microCombinado * 30 + index;
    }
    
    // Calcular microX y microY
    const microX = Math.floor(microCombinado / 24);
    const microY = microCombinado % 24;
    
    // Decodificar nano
    let nanoCombinado = 0;
    for (let i = 0; i < 2; i++) {
        const char = nanoCode.charAt(i);
        const index = GRID_CONFIG.ALPHABET.indexOf(char);
        if (index === -1) return { error: `Car√°cter inv√°lido en nano: ${char}` };
        nanoCombinado = nanoCombinado * 30 + index;
    }
    
    // Calcular nanoX y nanoY
    const nanoX = Math.floor(nanoCombinado / 25);
    const nanoY = nanoCombinado % 25;
    
    // Verificar checksum
    const totalCombinado = macroCombinado + microCombinado + nanoCombinado;
    const checksumEsperado = totalCombinado % 30;
    const checksumRecibido = GRID_CONFIG.ALPHABET.indexOf(checksumCode);
    
    if (checksumRecibido !== checksumEsperado) {
        return { error: "Checksum inv√°lido. C√≥digo corrupto." };
    }
    
    // Calcular coordenadas del centro
    const { ORIGIN_LAT, ORIGIN_LNG, RES_MACRO, RES_MICRO, RES_NANO } = GRID_CONFIG;
    
    const lat = ORIGIN_LAT - 
               (macroY * RES_MACRO) - 
               (microY * RES_MICRO) - 
               ((nanoY + 0.5) * RES_NANO);
    
    const lng = ORIGIN_LNG + 
               (macroX * RES_MACRO) + 
               (microX * RES_MICRO) + 
               ((nanoX + 0.5) * RES_NANO);
    
    // ID √∫nico para verificaci√≥n
    const idUnico = macroCombinado * 1000000 + microCombinado * 1000 + nanoCombinado;
    
    return {
        success: true,
        zona: zona,
        codigo: codigo,
        coordenadas: { lat, lng },
        indices: { macroX, macroY, microX, microY, nanoX, nanoY },
        idUnico: idUnico,
        precision: "18.5√ó18.5 metros"
    };
}

// ==============================================
// FUNCIONES AUXILIARES
// ==============================================

function obtenerVMLEVEL(latlng) {
    if (!rawZonas) return null;
    
    const punto = [latlng.lng, latlng.lat];
    const zonasEnPunto = leafletPip.pointInLayer(punto, L.geoJSON(rawZonas));
    
    if (zonasEnPunto.length > 0) {
        return zonasEnPunto[0].feature.properties.VM_LEVEL;
    }
    
    return null;
}

function estaEnAreaDefinida(latlng) {
    if (!rawZonas) return false;
    
    const punto = [latlng.lng, latlng.lat];
    const zonasEnPunto = leafletPip.pointInLayer(punto, L.geoJSON(rawZonas));
    return zonasEnPunto.length > 0;
}

// ==============================================
// DIBUJAR GRID F√çSICO (SIN CAMBIOS)
// ==============================================

function dibujarGridFisico() {
    const z = mymap.getZoom();
    
    if (z < 10) {
        gridLayer.clearLayers();
        labelLayer.clearLayers();
        return;
    }
    
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    
    const bounds = mymap.getBounds();
    const { ORIGIN_LAT, ORIGIN_LNG, RES_MACRO, RES_MICRO, RES_NANO, MACROS_X, MACROS_Y } = GRID_CONFIG;
    
    const visibleMacroXStart = Math.max(0, Math.floor((bounds.getWest() - ORIGIN_LNG) / RES_MACRO) - 1);
    const visibleMacroXEnd = Math.min(MACROS_X, Math.ceil((bounds.getEast() - ORIGIN_LNG) / RES_MACRO) + 1);
    const visibleMacroYStart = Math.max(0, Math.floor((ORIGIN_LAT - bounds.getNorth()) / RES_MACRO) - 1);
    const visibleMacroYEnd = Math.min(MACROS_Y, Math.ceil((ORIGIN_LAT - bounds.getSouth()) / RES_MACRO) + 1);
    
    // ZOOM 10-13: SOLO MACROS
    if (z >= 10 && z < 14) {
        for (let mx = visibleMacroXStart; mx < visibleMacroXEnd; mx++) {
            for (let my = visibleMacroYStart; my < visibleMacroYEnd; my++) {
                const lat1 = ORIGIN_LAT - (my * RES_MACRO);
                const lng1 = ORIGIN_LNG + (mx * RES_MACRO);
                const lat2 = lat1 - RES_MACRO;
                const lng2 = lng1 + RES_MACRO;
                
                L.rectangle([[lat1, lng1], [lat2, lng2]], {
                    color: '#1a73e8',
                    weight: 2,
                    opacity: 0.6,
                    fillOpacity: 0,
                    className: 'grid-macro'
                }).addTo(gridLayer);
                
                if (labelsEnabled) {
                    const centroLat = lat1 - (RES_MACRO / 2);
                    const centroLng = lng1 + (RES_MACRO / 2);
                    
                    const macroCombinado = mx * GRID_CONFIG.MACROS_Y + my;
                    const macroCode = toBase30(macroCombinado, 2);
                    
                    if (macroCode && macroCode.length === 2) {
                        const label = L.marker([centroLat, centroLng], {
                            icon: L.divIcon({
                                className: 'watermark-label-fixed',
                                html: `<div style="text-align:center;">${macroCode}</div>`,
                                iconSize: [40, 20],
                                iconAnchor: [20, 10]
                            }),
                            zIndexOffset: -1000
                        });
                        
                        if (bounds.contains([centroLat, centroLng])) {
                            label.addTo(labelLayer);
                        }
                    }
                }
            }
        }
    }
    
    // ZOOM 14-16: MICROS
    else if (z >= 14 && z < 17) {
        for (let mx = visibleMacroXStart; mx < visibleMacroXEnd; mx++) {
            for (let my = visibleMacroYStart; my < visibleMacroYEnd; my++) {
                const macroLat1 = ORIGIN_LAT - (my * RES_MACRO);
                const macroLng1 = ORIGIN_LNG + (mx * RES_MACRO);
                
                // Borde macro
                L.rectangle([[macroLat1, macroLng1], [macroLat1 - RES_MACRO, macroLng1 + RES_MACRO]], {
                    color: '#1a73e8',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0,
                    className: 'grid-macro'
                }).addTo(gridLayer);
                
                // L√≠neas micro (cada 6)
                for (let i = 0; i <= 24; i += 6) {
                    for (let j = 0; j <= 24; j += 6) {
                        const microLat1 = macroLat1 - (j * RES_MICRO);
                        const microLng1 = macroLng1 + (i * RES_MICRO);
                        
                        L.rectangle([
                            [microLat1, microLng1],
                            [microLat1 - (6 * RES_MICRO), microLng1 + (6 * RES_MICRO)]
                        ], {
                            color: '#3498db',
                            weight: i % 12 === 0 ? 1.5 : 0.8,
                            opacity: i % 12 === 0 ? 0.7 : 0.4,
                            dashArray: i % 12 === 0 ? 'none' : '5,5',
                            fillOpacity: 0,
                            className: 'grid-micro'
                        }).addTo(gridLayer);
                        
                        // Etiquetas micro
                        if (labelsEnabled && i % 12 === 0 && j % 12 === 0) {
                            const centroLat = microLat1 - (3 * RES_MICRO);
                            const centroLng = microLng1 + (3 * RES_MICRO);
                            
                            const microCombinado = i * 24 + j;
                            const microCode = toBase30(microCombinado, 2);
                            
                            if (microCode && microCode.length === 2) {
                                const label = L.marker([centroLat, centroLng], {
                                    icon: L.divIcon({
                                        className: 'micro-label-fixed',
                                        html: `<div style="text-align:center;">${microCode}</div>`,
                                        iconSize: [60, 20],
                                        iconAnchor: [30, 10]
                                    }),
                                    zIndexOffset: -1000
                                });
                                
                                if (bounds.contains([centroLat, centroLng])) {
                                    label.addTo(labelLayer);
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    // ZOOM 17+: NANOS
    else if (z >= 17) {
        for (let mx = visibleMacroXStart; mx < visibleMacroXEnd; mx++) {
            for (let my = visibleMacroYStart; my < visibleMacroYEnd; my++) {
                const macroLat1 = ORIGIN_LAT - (my * RES_MACRO);
                const macroLng1 = ORIGIN_LNG + (mx * RES_MACRO);
                
                // Borde macro
                L.rectangle([
                    [macroLat1, macroLng1],
                    [macroLat1 - RES_MACRO, macroLng1 + RES_MACRO]
                ], {
                    color: '#1a73e8',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0,
                    className: 'grid-macro'
                }).addTo(gridLayer);
                
                // L√≠neas micro
                for (let i = 0; i <= 24; i++) {
                    const vLat1 = macroLat1;
                    const vLng1 = macroLng1 + (i * RES_MICRO);
                    
                    L.polyline([[vLat1, vLng1], [vLat1 - RES_MACRO, vLng1]], {
                        color: '#3498db',
                        weight: 1.0,
                        opacity: 0.6,
                        className: 'grid-micro grid-helper'
                    }).addTo(gridLayer);
                    
                    const hLat1 = macroLat1 - (i * RES_MICRO);
                    const hLng1 = macroLng1;
                    
                    L.polyline([[hLat1, hLng1], [hLat1, hLng1 + RES_MACRO]], {
                        color: '#3498db',
                        weight: 1.0,
                        opacity: 0.6,
                        className: 'grid-micro grid-helper'
                    }).addTo(gridLayer);
                }
                
                // L√≠neas nano (cada 5)
                for (let mi = 0; mi < 24; mi++) {
                    for (let mj = 0; mj < 24; mj++) {
                        const microLat1 = macroLat1 - (mj * RES_MICRO);
                        const microLng1 = macroLng1 + (mi * RES_MICRO);
                        
                        for (let ni = 5; ni < 25; ni += 5) {
                            const nanoLng = microLng1 + (ni * RES_NANO);
                            L.polyline([
                                [microLat1, nanoLng],
                                [microLat1 - RES_MICRO, nanoLng]
                            ], {
                                color: '#2980b9',
                                weight: 0.4,
                                opacity: 0.3,
                                dashArray: '2, 3',
                                className: 'grid-nano nano-grid-line'
                            }).addTo(gridLayer);
                        }
                        
                        for (let nj = 5; nj < 25; nj += 5) {
                            const nanoLat = microLat1 - (nj * RES_NANO);
                            L.polyline([
                                [nanoLat, microLng1],
                                [nanoLat, microLng1 + RES_MICRO]
                            ], {
                                color: '#2980b9',
                                weight: 0.4,
                                opacity: 0.3,
                                dashArray: '2, 3',
                                className: 'grid-nano nano-grid-line'
                            }).addTo(gridLayer);
                        }
                    }
                }
                
                // Etiquetas nano
                if (labelsEnabled) {
                    for (let mi = 0; mi < 24; mi += 12) {
                        for (let mj = 0; mj < 24; mj += 12) {
                            const microLat1 = macroLat1 - (mj * RES_MICRO);
                            const microLng1 = macroLng1 + (mi * RES_MICRO);
                            
                            for (let ni = 12; ni < 25; ni += 12) {
                                for (let nj = 12; nj < 25; nj += 12) {
                                    const nanoLat = microLat1 - (nj * RES_NANO);
                                    const nanoLng = microLng1 + (ni * RES_NANO);
                                    
                                    if (!bounds.contains([nanoLat, nanoLng])) continue;
                                    
                                    const nanoCombinado = ni * 25 + nj;
                                    const nanoCode = toBase30(nanoCombinado, 2);
                                    
                                    if (nanoCode && nanoCode.length === 2) {
                                        const label = L.marker([nanoLat, nanoLng], {
                                            icon: L.divIcon({
                                                className: 'nano-label-fixed',
                                                html: `<div style="text-align:center;">${nanoCode}</div>`,
                                                iconSize: [30, 12],
                                                iconAnchor: [15, 6]
                                            }),
                                            zIndexOffset: -1000
                                        }).addTo(labelLayer);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

// ==============================================
// EVENTO CLIC PRINCIPAL - NUEVO SISTEMA
// ==============================================

mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    
    // Verificar si est√° en √°rea definida
    if (!estaEnAreaDefinida(e.latlng)) {
        mostrarPopupAreaNoDefinida(e.latlng);
        return;
    }
    
    // Solo mostrar c√≥digo postal en zoom >= 17
    const zoomActual = mymap.getZoom();
    if (zoomActual < 17) {
        mostrarPopupZoomInsuficiente(e.latlng);
        return;
    }
    
    // Generar c√≥digo postal √öNICO
    const vmLevel = obtenerVMLEVEL(e.latlng) || 'SINVM';
    const codigos = generarCodigoPostalUnico(e.latlng.lat, e.latlng.lng, vmLevel);
    
    if (!codigos) {
        mostrarPopupAreaNoDefinida(e.latlng);
        return;
    }
    
    // Resaltar celda nano
    const indices = coordenadaAIndices(e.latlng.lat, e.latlng.lng);
    if (indices) {
        const { ORIGIN_LAT, ORIGIN_LNG, RES_MICRO, RES_NANO } = GRID_CONFIG;
        
        const lat1 = ORIGIN_LAT - 
                    (indices.macroY * GRID_CONFIG.RES_MACRO) - 
                    (indices.microY * RES_MICRO) - 
                    (indices.nanoY * RES_NANO);
        
        const lng1 = ORIGIN_LNG + 
                    (indices.macroX * GRID_CONFIG.RES_MACRO) + 
                    (indices.microX * RES_MICRO) + 
                    (indices.nanoX * RES_NANO);
        
        const lat2 = lat1 - RES_NANO;
        const lng2 = lng1 + RES_NANO;
        
        L.rectangle([[lat1, lng1], [lat2, lng2]], {
            color: '#e74c3c',
            weight: 3,
            fillColor: '#e74c3c',
            fillOpacity: 0.4,
            className: 'highlighted-polygon'
        }).addTo(selectionLayer);
    }
    
    // Mostrar popup con c√≥digo √öNICO
    const popupOffset = [0, -50];
    const popupLatLng = L.latLng(e.latlng.lat + 0.00008, e.latlng.lng);
    
    const popup = L.popup({offset: popupOffset, className: 'nano-popup'})
        .setLatLng(popupLatLng)
        .setContent(`
            <div style="text-align:center; padding: 10px;">
                <div style="font-size: 12px; color: #1976d2; margin-bottom: 8px; font-weight: bold;">
                    üìç C√ìDIGO POSTAL √öNICO
                    <span class="unique-badge">SIN REPETICIONES</span>
                </div>
                
                <div class="codigo-completo" style="font-size: 11px;">
                    <strong>ID √önico:</strong> ${codigos.idUnico}<br>
                    <strong>Componentes:</strong> ${codigos.macroCode}${codigos.microCode}${codigos.nanoCode}
                </div>
                
                <div class="codigo-final">
                    ${codigos.codigoPostal}
                </div>
                
                <div style="font-size: 11px; color: #495057; margin: 8px 0; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Precisi√≥n:</strong> 18.5√ó18.5 m<br>
                    <strong>GPS:</strong> ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}
                </div>
                
                <div style="font-size: 10px; color: #27ae60; margin: 5px 0; padding: 4px; background: #d5f4e6; border-radius: 3px;">
                    ‚úÖ Este c√≥digo es √∫nico en Panam√°
                </div>
                
                <div style="display: flex; gap: 8px; justify-content: center; margin-top: 10px;">
                    <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">üìç MAPS</button>
                    <button class="btn-ws" onclick="window.open('https://wa.me/?text=${encodeURIComponent(`üìç C√≥digo Postal √önico: ${codigos.codigoPostal}\nID: ${codigos.idUnico}\nGPS: ${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`)}')">üí¨ WS</button>
                </div>
            </div>
        `)
        .openOn(mymap);
    
    popup.on('remove', function() {
        selectionLayer.clearLayers();
    });
});

// ==============================================
// BUSCADOR - NUEVO SISTEMA (7 D√çGITOS)
// ==============================================

document.getElementById('search-btn').addEventListener('click', () => {
    const input = document.getElementById('search-input').value.trim().toUpperCase();
    
    if (!input) {
        alert("Ingresa un c√≥digo postal\nFormato: Zona-7D√≠gitos\nEjemplo: E8399-A1B2C3D");
        return;
    }
    
    selectionLayer.clearLayers();
    
    // Verificar formato
    if (!input.includes('-')) {
        alert("Formato incorrecto. Usa: ZonaPostal-C√≥digo7D√≠gitos\nEj: E8399-A1B2C3D");
        return;
    }
    
    const partes = input.split('-');
    const zonaPostal = partes[0];
    const codigo7Digitos = partes[1];
    
    if (!codigo7Digitos || codigo7Digitos.length !== 7) {
        alert("El c√≥digo debe tener 7 d√≠gitos\nEj: A1B2C3D");
        return;
    }
    
    // Decodificar el c√≥digo
    const resultado = decodificarCodigoPostal(input);
    
    if (resultado.error) {
        alert(resultado.error);
        return;
    }
    
    if (!resultado.success) {
        alert("Error al decodificar el c√≥digo");
        return;
    }
    
    // Centrar mapa en la ubicaci√≥n
    const { lat, lng } = resultado.coordenadas;
    mymap.setView([lat, lng], 18);
    
    // Resaltar la celda nano
    const { ORIGIN_LAT, ORIGIN_LNG, RES_MACRO, RES_MICRO, RES_NANO } = GRID_CONFIG;
    const { macroY, microY, nanoY, macroX, microX, nanoX } = resultado.indices;
    
    const lat1 = ORIGIN_LAT - 
                (macroY * RES_MACRO) - 
                (microY * RES_MICRO) - 
                (nanoY * RES_NANO);
    
    const lng1 = ORIGIN_LNG + 
                (macroX * RES_MACRO) + 
                (microX * RES_MICRO) + 
                (nanoX * RES_NANO);
    
    const lat2 = lat1 - RES_NANO;
    const lng2 = lng1 + RES_NANO;
    
    L.rectangle([[lat1, lng1], [lat2, lng2]], {
        color: '#e74c3c',
        weight: 4,
        fillColor: '#e74c3c',
        fillOpacity: 0.4,
        className: 'highlighted-polygon'
    }).addTo(selectionLayer);
    
    // Mostrar popup
    setTimeout(() => {
        const popup = L.popup({className: 'nano-popup'})
            .setLatLng([lat, lng])
            .setContent(`
                <div style="text-align:center; padding: 10px;">
                    <div style="font-size: 12px; color: #1976d2; margin-bottom: 8px; font-weight: bold;">
                        üîç C√ìDIGO POSTAL ENCONTRADO
                        <span class="unique-badge">√öNICO</span>
                    </div>
                    
                    <div class="codigo-final" style="font-size: 16px;">
                        ${input}
                    </div>
                    
                    <div style="font-size: 11px; color: #495057; margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; text-align: left;">
                        <strong>Zona Postal:</strong> ${zonaPostal}<br>
                        <strong>ID √önico:</strong> ${resultado.idUnico}<br>
                        <strong>Precisi√≥n:</strong> ${resultado.precision}<br>
                        <strong>GPS:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}
                    </div>
                    
                    <div style="font-size: 10px; color: #27ae60; margin: 5px 0; padding: 4px; background: #d5f4e6; border-radius: 3px;">
                        ‚úÖ Verificaci√≥n: Checksum v√°lido
                    </div>
                    
                    <div style="display: flex; gap: 8px; justify-content: center; margin-top: 10px;">
                        <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${lat},${lng}')">üìç MAPS</button>
                        <button class="btn-ws" onclick="window.open('https://wa.me/?text=${encodeURIComponent(`üìç C√≥digo Postal √önico: ${input}\nID: ${resultado.idUnico}\nGPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`)}')">üí¨ WS</button>
                    </div>
                </div>
            `)
            .openOn(mymap);
            
        popup.on('remove', function() {
            selectionLayer.clearLayers();
        });
    }, 500);
});

// Tambi√©n manejar la tecla Enter
document.getElementById('search-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('search-btn').click();
    }
});

// ==============================================
// FUNCIONES DE POPUP (SIN CAMBIOS)
// ==============================================

function mostrarPopupZoomInsuficiente(latlng) {
    const popupOffset = [0, -60];
    const popupLatLng = L.latLng(latlng.lat + 0.00015, latlng.lng);
    
    L.popup({offset: popupOffset, className: 'warning-popup'})
        .setLatLng(popupLatLng)
        .setContent(`
            <div style="text-align:center; padding: 10px; max-width: 220px;">
                <div style="font-size: 12px; color: #e74c3c; margin-bottom: 5px; font-weight: bold;">
                    üîç ACERCA PARA C√ìDIGO POSTAL
                </div>
                <div style="font-size: 11px; color: #7f8c8d; margin-bottom: 10px;">
                    Haz zoom (nivel 17+) para obtener el c√≥digo postal √∫nico
                </div>
                <button class="btn-nav" onclick="mymap.setZoom(17)">üîç ZOOM IN</button>
            </div>
        `)
        .openOn(mymap);
}

function mostrarPopupAreaNoDefinida(latlng) {
    const popupOffset = [0, -60];
    const popupLatLng = L.latLng(latlng.lat + 0.00015, latlng.lng);
    
    L.popup({offset: popupOffset, className: 'warning-popup'})
        .setLatLng(popupLatLng)
        .setContent(`
            <div style="text-align:center; padding: 10px; max-width: 220px;">
                <div style="font-size: 12px; color: #e74c3c; margin-bottom: 5px; font-weight: bold;">
                    ‚ö†Ô∏è √ÅREA NO DEFINIDA
                </div>
                <div style="font-size: 11px; color: #7f8c8d; margin-bottom: 10px;">
                    Esta ubicaci√≥n est√° fuera del sistema postal
                </div>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${latlng.lat},${latlng.lng}')">üìç MAPS</button>
            </div>
        `)
        .openOn(mymap);
}

// ==============================================
// AGREGAR INFORMACI√ìN DE UNICIDAD
// ==============================================

function agregarInfoUnicidad() {
    const infoDiv = document.createElement('div');
    infoDiv.id = 'unicidad-info';
    infoDiv.innerHTML = `
        <div style="font-weight: bold; color: #27ae60; margin-bottom: 5px;">
            ‚úÖ SISTEMA SIN C√ìDIGOS REPETIDOS
        </div>
        <div style="font-size: 11px; line-height: 1.4;">
            ‚Ä¢ <strong>Formato:</strong> Zona-7D√≠gitos (Ej: E8399-A1B2C3D)<br>
            ‚Ä¢ <strong>Garant√≠a:</strong> Cada c√≥digo es √∫nico en Panam√°<br>
            ‚Ä¢ <strong>Precisi√≥n:</strong> 18.5√ó18.5 metros<br>
            ‚Ä¢ <strong>Total c√≥digos:</strong> 583 millones √∫nicos<br>
            ‚Ä¢ <strong>Verificaci√≥n:</strong> Incluye checksum anti-errores
        </div>
    `;
    document.body.appendChild(infoDiv);
}

// ==============================================
// CARGAR DATOS GEOJSON (SIN CAMBIOS)
// ==============================================

$.getJSON("estafetas.geojson", d => { 
    rawZonas = d; 
    L.geoJSON(d, {
        style: {color: "#2c3e50", weight: 1.5, fillOpacity: 0.05},
        onEachFeature: function(feature, layer) {
            layer.on('click', function(e) {
                mostrarPopupZona(e.latlng, feature);
                L.DomEvent.stopPropagation(e);
            });
        }
    }).addTo(zonasGeoLayer); 
});

$.getJSON("estafetasl.geojson", d => { 
    rutasData = d;
    L.geoJSON(d, {
        style: {color: "#e74c3c", weight: 4, opacity: 0.8},
        onEachFeature: function(feature, layer) {
            layer.on('click', function(e) {
                mostrarPopupRuta(e.latlng, feature);
                L.DomEvent.stopPropagation(e);
            });
        }
    }).addTo(rutasLayer);
});

$.getJSON("estafetasp.geojson", d => { 
    estafetasData = d;
    L.geoJSON(d, {
        pointToLayer: (f, ll) => L.circleMarker(ll, {
            radius: 8,
            color: "#27ae60", 
            fillColor: "#2ecc71", 
            fillOpacity: 0.9,
            weight: 3
        }),
        onEachFeature: function(feature, layer) {
            layer.on('click', function(e) {
                mostrarPopupEstafeta(e.latlng, feature);
                L.DomEvent.stopPropagation(e);
            });
        }
    }).addTo(estafetasPointsLayer);
});

// ==============================================
// CONTROLES Y EVENTOS (SIN CAMBIOS)
// ==============================================

// Control de GPS
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const c = L.DomUtil.create('div', 'leaflet-bar');
        const b = L.DomUtil.create('a', 'locate-button', c);
        b.innerHTML = 'üéØ';
        b.title = "Ubicar mi posici√≥n";
        L.DomEvent.on(b, 'click', e => { 
            L.DomEvent.stopPropagation(e); 
            mymap.locate({setView:true, maxZoom:18}); 
        });
        return c;
    }
});
mymap.addControl(new LocateControl());

// Control de capas
L.control.layers(null, {
    "Zonas Postales": zonasGeoLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "Cuadr√≠cula Postal": gridLayer,
    "Selecci√≥n": selectionLayer
}, {collapsed: false}).addTo(mymap);

// Toggle labels
$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    dibujarGridFisico();
});

// Eventos del mapa
let gridRedrawTimeout;
mymap.on('moveend zoomend', function() {
    if (gridRedrawTimeout) clearTimeout(gridRedrawTimeout);
    gridRedrawTimeout = setTimeout(() => {
        dibujarGridFisico();
    }, 100);
});

mymap.on('zoomstart movestart', function() {
    selectionLayer.clearLayers();
});

// Ubicaci√≥n del usuario
mymap.on('locationfound', function(e) {
    userLocationLayer.clearLayers();
    L.marker(e.latlng, {
        icon: L.divIcon({
            className: 'user-location-icon',
            html: 'üìç',
            iconSize: [30, 30]
        }),
        zIndexOffset: 1000
    }).addTo(userLocationLayer);
    
    L.circle(e.latlng, {
        radius: e.accuracy / 2,
        color: '#3498db',
        fillColor: '#3498db',
        fillOpacity: 0.1,
        weight: 1
    }).addTo(userLocationLayer);
});

// ==============================================
// INICIALIZACI√ìN
// ==============================================

// Dibujar grid inicial
setTimeout(() => {
    dibujarGridFisico();
    agregarInfoUnicidad();
}, 1000);

console.log("‚úÖ Sistema Postal 0.1¬∞ - SIN REPETICIONES");
console.log("‚Ä¢ Formato: Zona-7D√≠gitos (Ej: E8399-A1B2C3D)");
console.log("‚Ä¢ Garant√≠a: C√≥digos √∫nicos en todo Panam√°");
console.log("‚Ä¢ Total c√≥digos √∫nicos: 583,200,000");
console.log("‚Ä¢ Precisi√≥n: 18.5√ó18.5 metros");
console.log("‚Ä¢ Incluye checksum de verificaci√≥n");
</script>
</body>
</html>
