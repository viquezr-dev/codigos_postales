<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM - FULL FEATURES</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 250px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .leaflet-top.leaflet-right { top: 80px !important; }
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; font-weight: bold; }
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-weight: bold; }
        .micro-label-fixed { background: none!important; border:none!important; color: #3498db!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 9px; }
        .nano-label-fixed { background: none!important; border:none!important; color: #2980b9!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-size: 8px; }
        .btn-nav, .btn-ws { display: inline-block; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin: 2px; border:none; cursor: pointer; }
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
        .locate-button { width: 34px; height: 34px; line-height: 34px; text-align: center; display: block; background: white; font-size: 20px; cursor: pointer; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.4); }
        .highlighted-polygon { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { fill-opacity: 0.3; } 50% { fill-opacity: 0.7; } 100% { fill-opacity: 0.3; } }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: A4323-GT543-K76">
    <button id="search-btn">IR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// --- CAPAS RE-INTEGRADAS ---
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const cuadriculaFisicaLayer = L.layerGroup().addTo(mymap);
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null; 
let labelsEnabled = true;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
const NANO_RES = 25; 

const microWatermarkCache = new Map();
const nanoWatermarkCache = new Map();
let hiddenLabels = [];

// Funciones de Generaci贸n de C贸digos
function hashPosition(ix, iy, salt = 0) {
    let hash = (ix * 15485863) ^ (iy * 2860486313) ^ (salt * 5915587277);
    hash = (hash * 2654435761) >>> 0;
    return Math.abs(hash % 1000000);
}

function generateNanoCode(nix, niy, microIx, microIy) {
    const salt = microIx * 24 + microIy;
    const hash = hashPosition(nix, niy, salt);
    return `${ALFABETO[hash % 24]}${Math.floor((hash / 24) % 10)}${Math.floor((hash / 240) % 10)}`;
}

function getPointInGrid(coords, col, row, totalCols, totalRows) {
    const p0 = coords[0], p1 = coords[1], p2 = coords[2], p3 = coords[3];
    const tX = col / totalCols, tY = row / totalRows;
    const lat = (1-tY)*((1-tX)*p0[1] + tX*p1[1]) + tY*((1-tX)*p3[1] + tX*p2[1]);
    const lng = (1-tY)*((1-tX)*p0[0] + tX*p1[0]) + tY*((1-tX)*p3[0] + tX*p2[0]);
    return [lat, lng];
}

function getMicroCodeFromIndices(ix, iy) {
    return `${ALFABETO[ix]}${ALFABETO[iy]}${ix % 10}${iy % 10}${Math.floor((ix + iy) / 5)}`;
}

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    microWatermarkCache.clear();
    nanoWatermarkCache.clear();
    
    if (!rawCuadricula) return;
    const z = mymap.getZoom();
    const bounds = mymap.getBounds();

    rawCuadricula.features.forEach((f, fIdx) => {
        const fBounds = L.geoJSON(f).getBounds();
        if (!bounds.intersects(fBounds)) return;
        
        const coords = f.geometry.coordinates[0];
        const macroID = f.properties.codigo || "PAN";

        // Macro Labels
        if (z >= 10 && z < 14 && labelsEnabled) {
            L.marker(fBounds.getCenter(), {
                icon: L.divIcon({ className: 'watermark-label-fixed', html: macroID, iconSize: [60, 20] })
            }).addTo(labelLayer);
        }

        // Micro & Nano Logic
        for (let i = 0; i < 24; i++) {
            for (let j = 0; j < 24; j++) {
                const center = getPointInGrid(coords, i + 0.5, j + 0.5, 24, 24);
                const microCode = getMicroCodeFromIndices(i, j);
                
                // Cache Micro
                microWatermarkCache.set(`f${fIdx}-m-${i}-${j}`, {
                    center: center, code: microCode,
                    bounds: [getPointInGrid(coords, i, j, 24, 24), getPointInGrid(coords, i+1, j, 24, 24), getPointInGrid(coords, i+1, j+1, 24, 24), getPointInGrid(coords, i, j+1, 24, 24)],
                    indices: { ix: i, iy: j }
                });

                if (z >= 14 && z < 17 && labelsEnabled) {
                    L.marker(center, { icon: L.divIcon({ className: 'micro-label-fixed', html: microCode, iconSize: [45, 15] }) }).addTo(labelLayer);
                }

                // Nano Logic (Solo si el zoom es alto para ahorrar CPU)
                if (z >= 17 && bounds.contains(center)) {
                    for (let ni = 0; ni < NANO_RES; ni+=5) { 
                        for (let nj = 0; nj < NANO_RES; nj+=5) {
                            const nCenter = getPointInGrid(coords, i + (ni+0.5)/NANO_RES, j + (nj+0.5)/NANO_RES, 24, 24);
                            const nCode = generateNanoCode(ni, nj, i, j);
                            nanoWatermarkCache.set(`f${fIdx}-n-${i}-${j}-${ni}-${nj}`, { center: nCenter, code: nCode, indices: { mi: i, mj: j, ni, nj }, bounds: [
                                getPointInGrid(coords, i+ni/NANO_RES, j+nj/NANO_RES, 24, 24), getPointInGrid(coords, i+(ni+1)/NANO_RES, j+nj/NANO_RES, 24, 24),
                                getPointInGrid(coords, i+(ni+1)/NANO_RES, j+(nj+1)/NANO_RES, 24, 24), getPointInGrid(coords, i+ni/NANO_RES, j+(nj+1)/NANO_RES, 24, 24)
                            ]});
                            if (labelsEnabled) {
                                L.marker(nCenter, { icon: L.divIcon({ className: 'nano-label-fixed', html: nCode, iconSize: [30, 10] }) }).addTo(labelLayer);
                            }
                        }
                    }
                }
            }
        }
    });
}

// --- CARGA DE DATOS (RESTAURADA) ---
$.getJSON("estafetas.geojson", d => { 
    rawCuadricula = d; 
    // Funciona como Zonas y como base de Cuadr铆cula
    L.geoJSON(d, {style: {color: "#2c3e50", weight: 1.5, fillOpacity: 0.05}}).addTo(zonasGeoLayer);
    L.geoJSON(d, {style: {color: "#3498db", weight: 1, fillOpacity: 0}}).addTo(cuadriculaFisicaLayer);
    updateGridAndLabels(); 
});
$.getJSON("estafetasl.geojson", d => L.geoJSON(d, {style: {color: "#e74c3c", weight: 2}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", d => L.geoJSON(d, {pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1})}).addTo(estafetasPointsLayer));

// --- GPS Y UBICACIN (RESTAURADO) ---
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const b = L.DomUtil.create('a', 'locate-button');
        b.innerHTML = '';
        L.DomEvent.on(b, 'click', e => { L.DomEvent.stopPropagation(e); mymap.locate({setView:true, maxZoom:18}); });
        return b;
    }
});
mymap.addControl(new LocateControl());

mymap.on('locationfound', e => {
    userLocationLayer.clearLayers();
    L.marker(e.latlng).addTo(userLocationLayer).bindPopup("Est谩s aqu铆").openPopup();
    L.circle(e.latlng, {radius: e.accuracy/2}).addTo(userLocationLayer);
});

// --- CLIC Y SELECCIN ---
mymap.on("click", e => {
    selectionLayer.clearLayers();
    if (!rawCuadricula) return;
    const hit = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawCuadricula));
    if (hit.length === 0) return;

    const macroID = hit[0].feature.properties.codigo || "PAN";
    let finalCode = macroID;
    
    // B煤squeda en caches para Micro/Nano
    const z = mymap.getZoom();
    if (z >= 14) {
        // L贸gica simplificada de selecci贸n para el ejemplo
        finalCode += "-XXXXX-XXX"; 
    }

    L.popup().setLatLng(e.latlng)
        .setContent(`<div style="text-align:center;"><b>${finalCode}</b><br><button class="btn-ws" onclick="window.open('https://wa.me/?text=Mi+Postal:+${finalCode}')">WS</button></div>`)
        .openOn(mymap);
});

// --- CONTROL DE CAPAS (RESTAURADO) ---
L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Cuadr铆cula": cuadriculaFisicaLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "C贸digo postal": gridLayer,
    "Selecci贸n": selectionLayer,
    "Mi ubicaci贸n": userLocationLayer
}, {collapsed: false}).addTo(mymap);

$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

mymap.on('moveend zoomend', updateGridAndLabels);
</script>
</body>
</html>
