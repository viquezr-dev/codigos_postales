<!DOCTYPE html>
<html lang="es">
<head>
    <title>SISTEMAS POSTALES DE PANAM√Å - OPTIMIZADO</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; background: #ddd; }
        .search-container { position: absolute; top: 10px; right: 10px; z-index: 5000; display: flex; gap: 5px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; }
        #search-input { flex: 1; border: 1px solid #ccc; padding: 5px; outline: none; font-family: monospace; font-size: 14px; text-transform: uppercase; border-radius: 4px; }
        #search-btn { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .leaflet-tooltip.watermark-tooltip { background: transparent!important; border: none!important; box-shadow: none!important; color: rgba(0,0,0,0.4); font-weight: bold; font-family: monospace; pointer-events: none; }
        .codigo-final { background: #1a2a6c; color: white; padding: 12px; border-radius: 6px; font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 8px; border: 2px solid #f1c40f; font-family: monospace; }
        .locate-button { position: absolute; bottom: 30px; left: 10px; z-index: 1000; background: white; width: 40px; height: 40px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .inv { background: none; border: none; }
    </style>
</head>
<body>

<div class="search-container">
    <input type="text" id="search-input" placeholder="C√ìDIGO POSTAL...">
    <button id="search-btn">IR</button>
</div>

<button class="locate-button" onclick="findMe()">üß≠</button>
<div id="mapid"></div>

<script>
const ORIGIN = { lat: 10.0, lng: -83.0 };
const ALFA = "23456789ABCDEFGHJKLMNPQRSTVWXYZ";
const R_3M = 0.000027; 

const PARAMS = {
    RES_NANO: R_3M,
    RES_MICRO: R_3M * 30, 
    RES_MACRO: R_3M * 30 * 30,
    MACRO_X_COUNT: 2000
};

const mymap = L.map('mapid', { zoomSnap: 0.5, zoomControl: false, maxZoom: 22 }).setView([8.5, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 22 }).addTo(mymap);

// Capas
const layerZonas = L.geoJSON(null, { 
    style: { color: "#333", weight: 1.5, fillOpacity: 0.1 },
    onEachFeature: (f, l) => {
        l.on({
            mouseover: (e) => e.target.setStyle({ color: '#f1c40f', fillOpacity: 0.3 }),
            mouseout: (e) => layerZonas.resetStyle(e.target),
            click: (e) => { seleccionar(e.latlng.lat, e.latlng.lng, f.properties.VM_LEVEL); L.DomEvent.stopPropagation(e); }
        })
    }
}).addTo(mymap);

const layerMacro = L.layerGroup().addTo(mymap);
const layerMicro = L.layerGroup().addTo(mymap);
const layerLocalNano = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);

fetch('estafetas.geojson').then(r => r.json()).then(data => layerZonas.addData(data));

function encode(num, len) {
    let s = ""; let n = Math.abs(Math.floor(num));
    for (let i = 0; i < len; i++) { s = ALFA[n % 30] + s; n = Math.floor(n / 30); }
    return s;
}

function getGridInfo(lat, lng) {
    const gx = Math.round((lng - ORIGIN.lng) / PARAMS.RES_NANO);
    const gy = Math.round((ORIGIN.lat - lat) / PARAMS.RES_NANO);
    return {
        macro: encode((Math.floor(gy/900) * PARAMS.MACRO_X_COUNT) + Math.floor(gx/900), 3),
        micro: encode((Math.floor((gy%900)/30) * 30) + Math.floor((gx%900)/30), 3),
        nano: encode((Math.floor(gy%30) * 30) + Math.floor(gx%30), 2)
    };
}

function seleccionar(lat, lng, forcedZonaID = null) {
    selectionLayer.clearLayers();
    layerLocalNano.clearLayers();
    let zonaID = forcedZonaID;
    if (!zonaID) {
        layerZonas.eachLayer(l => { if (l.getBounds().contains([lat, lng])) zonaID = l.feature.properties.VM_LEVEL; });
    }
    if (!zonaID) return;

    const res = getGridInfo(lat, lng);
    const z = mymap.getZoom();
    let codigoFinal = "";
    
    if (z < 13) codigoFinal = zonaID;
    else if (z < 16) codigoFinal = `${zonaID}-${res.macro}`;
    else if (z < 18) codigoFinal = `${zonaID}-${res.macro}-${res.micro}`;
    else {
        let zonaLimpia = zonaID.toString().charAt(0) + zonaID.toString().substring(3);
        codigoFinal = `${zonaLimpia}${res.macro}-${res.micro}${res.nano}`;
        
        // Dibujar solo rejilla local 3m (30x30 cuadros = 900 rect√°ngulos, seguro para el navegador)
        const mStep = PARAMS.RES_MICRO;
        const mX = Math.floor((lng - ORIGIN.lng) / mStep) * mStep + ORIGIN.lng;
        const mY = ORIGIN.lat - Math.floor((ORIGIN.lat - lat) / mStep) * mStep;
        for(let i=0; i<30; i++) {
            for(let j=0; j<30; j++) {
                L.rectangle([[mY - i*R_3M, mX + j*R_3M], [mY - (i+1)*R_3M, mX + (j+1)*R_3M]], 
                { color: '#2c3e50', weight: 0.5, fill: false, opacity: 0.2 }).addTo(layerLocalNano);
            }
        }
    }

    L.marker([lat, lng]).addTo(selectionLayer)
        .bindPopup(`<div class="codigo-final">${codigoFinal}</div>`).openPopup();
}

function render() {
    layerMacro.clearLayers(); layerMicro.clearLayers();
    const z = mymap.getZoom();
    if (z < 9) return;
    
    const b = mymap.getBounds();
    const drawGrid = (step, layer, color, maxItems) => {
        let count = 0;
        const startLng = Math.floor((b.getWest() - ORIGIN.lng) / step) * step + ORIGIN.lng;
        const startLat = ORIGIN.lat - Math.floor((ORIGIN.lat - b.getNorth()) / step) * step;
        for (let lo = startLng; lo < b.getEast(); lo += step) {
            for (let la = startLat; la > b.getSouth(); la -= step) {
                if (++count > maxItems) return; // Auditor√≠a de rendimiento
                L.rectangle([[la, lo], [la - step, lo + step]], { color: color, weight: 1, fill: false, opacity: 0.2 }).addTo(layer);
            }
        }
    };

    if (z >= 9 && z < 13) drawGrid(PARAMS.RES_MACRO, layerMacro, '#1a73e8', 400);
    if (z >= 13) drawGrid(PARAMS.RES_MICRO, layerMicro, '#e67e22', 400);
}

function findMe() { mymap.locate({setView: true, maxZoom: 18}); }
mymap.on('locationfound', (e) => seleccionar(e.latlng.lat, e.latlng.lng));
mymap.on('click', (e) => seleccionar(e.latlng.lat, e.latlng.lng));
mymap.on('moveend', render);
render();
</script>
</body>
</html>
