<!DOCTYPE html>
<html>
<head>
    <title>PanamaCode - Sistema Postal</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 300px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; font-weight: bold; }
        .code-display {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 1px;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border: 2px solid #3498db;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .coord-info {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background: #f1f8ff;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            border-left: 3px solid #3498db;
        }
        .btn-nav, .btn-ws { display: inline-block; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin: 2px; border:none; cursor: pointer; }
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
        .warning-popup .leaflet-popup-content-wrapper {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }
        .warning-popup .leaflet-popup-tip {
            background: #ffc107;
        }
        .highlighted-cell {
            animation: pulse 1.5s infinite;
            stroke-dasharray: 5,5;
        }
        @keyframes pulse {
            0% { fill-opacity: 0.2; stroke-width: 2; }
            50% { fill-opacity: 0.4; stroke-width: 3; }
            100% { fill-opacity: 0.2; stroke-width: 2; }
        }
        .grid-line { pointer-events: none; }
        .performance-note {
            position: absolute;
            bottom: 70px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            color: #666;
            z-index: 5000;
        }
    </style>
</head>
<body>

<div class="performance-note">PanamaCode v1.0 | Base32 | 12 chars</div>
<div class="map-title"><h1>PanamaCode - Sistema Postal por Coordenadas</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: 8A9B-X3Y7-Z5W2">
    <button id="search-btn">BUSCAR</button>
</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
// ==================== CONFIGURACI√ìN ====================
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// Capas
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const gridLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawZonas = null;

// ==================== SISTEMA PanamaCode ====================

// Base32 optimizada para Panam√° (sin caracteres ambiguos)
const BASE32 = "23456789ABCDEFGHJKMNPQRSTUVWXYZ";
const BASE32_MAP = {};
for (let i = 0; i < BASE32.length; i++) {
    BASE32_MAP[BASE32[i]] = i;
}

// Punto de referencia para Panam√° (David, Chiriqu√≠)
const REF_POINT = {
    lat: 8.431,   // David
    lng: -82.431  // David
};

// Resoluciones (en grados, aprox)
// 1 grado ‚âà 111km
const RESOLUTIONS = {
    'REGION': 1.0,      // ~111km
    'SECTOR': 0.01,     // ~1.1km
    'CELDA': 0.0001     // ~11m
};

// Dimensiones del grid (mismo que tu sistema)
const GRID_DIMENSIONS = {
    'REGION': 32,   // 32√ó32 regiones grandes
    'SECTOR': 24,   // 24√ó24 sectores por regi√≥n
    'CELDA': 25     // 25√ó25 celdas por sector
};

// ==================== FUNCIONES PRINCIPALES ====================

// Codificar n√∫mero a Base32
function encodeBase32(number, length = 2) {
    let result = '';
    for (let i = 0; i < length; i++) {
        const digit = number & 31; // M√≥dulo 32
        result = BASE32[digit] + result;
        number = number >>> 5; // Dividir por 32
    }
    return result;
}

// Decodificar Base32
function decodeBase32(str) {
    let result = 0;
    for (let i = 0; i < str.length; i++) {
        result = (result * 32) + (BASE32_MAP[str[i]] || 0);
    }
    return result;
}

// Normalizar coordenada relativa al punto de referencia
function normalizeCoordinate(lat, lng) {
    return {
        normLat: (lat - REF_POINT.lat) * 1000, // Convertir a "mil√©simas"
        normLng: (lng - REF_POINT.lng) * 1000
    };
}

// Calcular √≠ndices de grid
function calculateGridIndices(lat, lng) {
    const { normLat, normLng } = normalizeCoordinate(lat, lng);
    
    // Convertir a √≠ndices positivos
    const offset = 1000000; // Para evitar negativos
    
    // √çndices para regi√≥n (~100km)
    const regionX = Math.floor((normLng + offset) / (RESOLUTIONS.REGION * 1000));
    const regionY = Math.floor((normLat + offset) / (RESOLUTIONS.REGION * 1000));
    
    // √çndices para sector (~1km) dentro de la regi√≥n
    const sectorX = Math.floor(((normLng + offset) % (RESOLUTIONS.REGION * 1000)) / (RESOLUTIONS.SECTOR * 1000));
    const sectorY = Math.floor(((normLat + offset) % (RESOLUTIONS.REGION * 1000)) / (RESOLUTIONS.SECTOR * 1000));
    
    // √çndices para celda (~10m) dentro del sector
    const celdaX = Math.floor((((normLng + offset) % (RESOLUTIONS.REGION * 1000)) % (RESOLUTIONS.SECTOR * 1000)) / (RESOLUTIONS.CELDA * 1000));
    const celdaY = Math.floor((((normLat + offset) % (RESOLUTIONS.REGION * 1000)) % (RESOLUTIONS.SECTOR * 1000)) / (RESOLUTIONS.CELDA * 1000));
    
    return {
        region: { x: regionX % 32, y: regionY % 32 },
        sector: { x: sectorX % 24, y: sectorY % 24 },
        celda: { x: celdaX % 25, y: celdaY % 25 }
    };
}

// Generar PanamaCode
function generatePanamaCode(lat, lng) {
    const indices = calculateGridIndices(lat, lng);
    
    // Codificar cada nivel
    const regionCode = encodeBase32(indices.region.x) + encodeBase32(indices.region.y);
    const sectorCode = encodeBase32(indices.sector.x) + encodeBase32(indices.sector.y);
    const celdaCode = encodeBase32(indices.celda.x) + encodeBase32(indices.celda.y);
    
    return `${regionCode}-${sectorCode}-${celdaCode}`;
}

// Decodificar PanamaCode a coordenadas aproximadas
function decodePanamaCode(code) {
    const parts = code.split('-');
    if (parts.length !== 3) return null;
    
    const [regionCode, sectorCode, celdaCode] = parts;
    
    // Decodificar
    const regionX = decodeBase32(regionCode.substring(0, 2));
    const regionY = decodeBase32(regionCode.substring(2, 4));
    const sectorX = decodeBase32(sectorCode.substring(0, 2));
    const sectorY = decodeBase32(sectorCode.substring(2, 4));
    const celdaX = decodeBase32(celdaCode.substring(0, 2));
    const celdaY = decodeBase32(celdaCode.substring(2, 4));
    
    // Calcular coordenadas
    const offset = 1000000;
    
    const lng = REF_POINT.lng + (
        (regionX * RESOLUTIONS.REGION * 1000) +
        (sectorX * RESOLUTIONS.SECTOR * 1000) +
        (celdaX * RESOLUTIONS.CELDA * 1000) - offset
    ) / 1000;
    
    const lat = REF_POINT.lat + (
        (regionY * RESOLUTIONS.REGION * 1000) +
        (sectorY * RESOLUTIONS.SECTOR * 1000) +
        (celdaY * RESOLUTIONS.CELDA * 1000) - offset
    ) / 1000;
    
    // Calcular bounds de la celda (~11m)
    const cellSize = RESOLUTIONS.CELDA;
    const bounds = [
        [lat - cellSize/2, lng - cellSize/2],
        [lat - cellSize/2, lng + cellSize/2],
        [lat + cellSize/2, lng + cellSize/2],
        [lat + cellSize/2, lng - cellSize/2]
    ];
    
    return {
        lat,
        lng,
        bounds,
        regionCode,
        sectorCode,
        celdaCode,
        indices: {
            region: { x: regionX, y: regionY },
            sector: { x: sectorX, y: sectorY },
            celda: { x: celdaX, y: celdaY }
        }
    };
}

// Verificar si est√° dentro de √°rea postal
function isInPostalArea(lat, lng) {
    if (!rawZonas) return false;
    
    // Crear capa temporal
    const point = [lng, lat];
    const geoLayer = L.geoJSON(rawZonas);
    
    // Verificar si el punto est√° dentro de alg√∫n pol√≠gono
    let isInside = false;
    geoLayer.eachLayer(function(layer) {
        if (layer.getBounds && layer.getBounds().contains([lat, lng])) {
            isInside = true;
        }
    });
    
    return isInside;
}

// ==================== VISUALIZACI√ìN ====================

function updateGrid() {
    gridLayer.clearLayers();
    
    const z = mymap.getZoom();
    
    if (z >= 12) {
        drawGrid(z);
    }
}

function drawGrid(zoom) {
    const bounds = mymap.getBounds();
    
    if (zoom >= 12 && zoom < 15) {
        // Grid de regiones (~100km)
        drawRegionGrid(bounds);
    } else if (zoom >= 15 && zoom < 18) {
        // Grid de sectores (~1km)
        drawSectorGrid(bounds);
    } else if (zoom >= 18) {
        // Grid de celdas (~11m)
        drawCeldaGrid(bounds);
    }
}

function drawRegionGrid(bounds) {
    const cellSize = RESOLUTIONS.REGION;
    
    const startLng = Math.floor(bounds.getWest() / cellSize) * cellSize;
    const endLng = Math.ceil(bounds.getEast() / cellSize) * cellSize;
    const startLat = Math.floor(bounds.getSouth() / cellSize) * cellSize;
    const endLat = Math.ceil(bounds.getNorth() / cellSize) * cellSize;
    
    for (let lng = startLng; lng <= endLng; lng += cellSize) {
        L.polyline([
            [startLat, lng],
            [endLat, lng]
        ], {
            color: '#3498db',
            weight: 1,
            opacity: 0.3,
            className: 'grid-line'
        }).addTo(gridLayer);
    }
    
    for (let lat = startLat; lat <= endLat; lat += cellSize) {
        L.polyline([
            [lat, startLng],
            [lat, endLng]
        ], {
            color: '#3498db',
            weight: 1,
            opacity: 0.3,
            className: 'grid-line'
        }).addTo(gridLayer);
    }
}

function drawSectorGrid(bounds) {
    const cellSize = RESOLUTIONS.SECTOR;
    
    const startLng = Math.floor(bounds.getWest() / cellSize) * cellSize;
    const endLng = Math.ceil(bounds.getEast() / cellSize) * cellSize;
    const startLat = Math.floor(bounds.getSouth() / cellSize) * cellSize;
    const endLat = Math.ceil(bounds.getNorth() / cellSize) * cellSize;
    
    for (let lng = startLng; lng <= endLng; lng += cellSize) {
        L.polyline([
            [bounds.getSouth(), lng],
            [bounds.getNorth(), lng]
        ], {
            color: '#2980b9',
            weight: 0.5,
            opacity: 0.2,
            className: 'grid-line'
        }).addTo(gridLayer);
    }
    
    for (let lat = startLat; lat <= endLat; lat += cellSize) {
        L.polyline([
            [lat, bounds.getWest()],
            [lat, bounds.getEast()]
        ], {
            color: '#2980b9',
            weight: 0.5,
            opacity: 0.2,
            className: 'grid-line'
        }).addTo(gridLayer);
    }
}

function drawCeldaGrid(bounds) {
    const cellSize = RESOLUTIONS.CELDA;
    
    const startLng = Math.floor(bounds.getWest() / cellSize) * cellSize;
    const endLng = Math.ceil(bounds.getEast() / cellSize) * cellSize;
    const startLat = Math.floor(bounds.getSouth() / cellSize) * cellSize;
    const endLat = Math.ceil(bounds.getNorth() / cellSize) * cellSize;
    
    // Dibujar cada 5 l√≠neas para no saturar
    for (let lng = startLng; lng <= endLng; lng += cellSize * 5) {
        L.polyline([
            [bounds.getSouth(), lng],
            [bounds.getNorth(), lng]
        ], {
            color: '#2c3e50',
            weight: 0.3,
            opacity: 0.1,
            className: 'grid-line'
        }).addTo(gridLayer);
    }
    
    for (let lat = startLat; lat <= endLat; lat += cellSize * 5) {
        L.polyline([
            [lat, bounds.getWest()],
            [lat, bounds.getEast()]
        ], {
            color: '#2c3e50',
            weight: 0.3,
            opacity: 0.1,
            className: 'grid-line'
        }).addTo(gridLayer);
    }
}

// ==================== EVENTO CLIC ====================

mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    
    // Verificar si est√° en √°rea postal
    const inPostalArea = isInPostalArea(lat, lng);
    
    if (!inPostalArea) {
        showNoCodePopup(e.latlng);
        return;
    }
    
    // Generar PanamaCode
    const code = generatePanamaCode(lat, lng);
    const decoded = decodePanamaCode(code);
    
    if (!decoded) return;
    
    // Destacar celda
    L.polygon(decoded.bounds, {
        color: '#e74c3c',
        weight: 2,
        fillColor: '#e74c3c',
        fillOpacity: 0.3,
        className: 'highlighted-cell'
    }).addTo(selectionLayer);
    
    // Mostrar popup
    showCodePopup(e.latlng, code, decoded);
});

function showNoCodePopup(latlng) {
    const popup = L.popup()
        .setLatLng([latlng.lat, latlng.lng])
        .setContent(`
            <div style="text-align:center; padding: 15px; min-width: 250px;">
                <div style="color: #e74c3c; font-size: 16px; margin-bottom: 10px;">
                    ‚ö†Ô∏è SIN C√ìDIGO POSTAL
                </div>
                <div style="color: #7f8c8d; font-size: 13px; margin-bottom: 15px;">
                    Fuera del √°rea de cobertura postal
                </div>
                <div class="coord-info">
                    ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${latlng.lat},${latlng.lng}')">
                        üìç Maps
                    </button>
                    <button class="btn-ws" onclick="window.open('https://wa.me/?text=${encodeURIComponent(`üìç ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`)}')">
                        üí¨ Compartir
                    </button>
                </div>
            </div>
        `)
        .openOn(mymap);
}

function showCodePopup(latlng, code, decoded) {
    const popupContent = `
        <div style="text-align:center; padding: 15px; min-width: 280px;">
            <div style="font-size: 14px; color: #3498db; margin-bottom: 5px;">
                üè∑Ô∏è PanamaCode
            </div>
            
            <div class="code-display">
                ${code}
            </div>
            
            <div style="font-size: 12px; color: #666; margin: 10px 0;">
                <div><strong>Formato:</strong> Regi√≥n-Sector-Celda</div>
                <div><strong>Precisi√≥n:</strong> ~11 metros</div>
                <div><strong>Sistema:</strong> Base32</div>
            </div>
            
            <div class="coord-info">
                <div>üìç ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</div>
                <div>üó∫Ô∏è Regi√≥n: ${decoded.regionCode}</div>
                <div>üì¶ Sector: ${decoded.sectorCode}</div>
                <div>üì≠ Celda: ${decoded.celdaCode}</div>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${latlng.lat},${latlng.lng}')">
                    üìç MAPS
                </button>
                <button class="btn-ws" onclick="window.open('https://wa.me/?text=${encodeURIComponent(`üìç PanamaCode: ${code}\nüìå ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`)}')">
                    üí¨ WS
                </button>
            </div>
            
            <div style="margin-top: 10px; font-size: 10px; color: #95a5a6;">
                v1.0 | 12 caracteres | Base32
            </div>
        </div>
    `;
    
    const popup = L.popup()
        .setLatLng([latlng.lat, latlng.lng])
        .setContent(popupContent)
        .openOn(mymap);
    
    popup.on('remove', () => {
        selectionLayer.clearLayers();
    });
}

// ==================== BUSCADOR ====================

document.getElementById('search-btn').addEventListener('click', () => {
    const code = document.getElementById('search-input').value.trim().toUpperCase();
    
    if (!code) return;
    
    // Validar formato
    const codeRegex = /^[23456789ABCDEFGHJKMNPQRSTUVWXYZ]{4}-[23456789ABCDEFGHJKMNPQRSTUVWXYZ]{4}-[23456789ABCDEFGHJKMNPQRSTUVWXYZ]{4}$/;
    if (!codeRegex.test(code)) {
        alert('Formato inv√°lido. Use: XXXX-XXXX-XXXX (solo Base32)');
        return;
    }
    
    const decoded = decodePanamaCode(code);
    
    if (!decoded) {
        alert('C√≥digo no v√°lido o fuera de rango');
        return;
    }
    
    // Limpiar selecci√≥n
    selectionLayer.clearLayers();
    
    // Centrar mapa
    mymap.setView([decoded.lat, decoded.lng], 18);
    
    // Destacar celda
    L.polygon(decoded.bounds, {
        color: '#e74c3c',
        weight: 3,
        fillColor: '#e74c3c',
        fillOpacity: 0.3
    }).addTo(selectionLayer);
    
    // Actualizar input
    document.getElementById('search-input').value = code;
});

// ==================== CARGA DE DATOS ====================

// Cargar zonas postales (solo para visualizaci√≥n)
$.getJSON("estafetas.geojson", d => { 
    rawZonas = d; 
    
    L.geoJSON(d, {
        style: {
            color: '#2c3e50',
            weight: 1.5,
            fillOpacity: 0.03,
            opacity: 0.6
        },
        interactive: false
    }).addTo(zonasGeoLayer);
    
    updateGrid();
}).fail(() => {
    console.log("No se encontr√≥ estafetas.geojson");
});

// ==================== CONTROLES ====================

// Control de GPS
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', '', container);
        button.innerHTML = 'üéØ';
        button.style.cssText = 'width: 30px; height: 30px; line-height: 30px; text-align: center; display: block; background: white; border-radius: 5px; cursor: pointer;';
        button.title = "Mi ubicaci√≥n";
        
        L.DomEvent.on(button, 'click', (e) => {
            L.DomEvent.stopPropagation(e);
            mymap.locate({setView: true, maxZoom: 16});
        });
        
        return container;
    }
});
mymap.addControl(new LocateControl());

// Evento de ubicaci√≥n
mymap.on('locationfound', function(e) {
    userLocationLayer.clearLayers();
    
    L.circleMarker(e.latlng, {
        radius: 8,
        color: '#3498db',
        fillColor: '#3498db',
        fillOpacity: 0.7
    }).addTo(userLocationLayer);
    
    // Generar PanamaCode para ubicaci√≥n actual
    const code = generatePanamaCode(e.latlng.lat, e.latlng.lng);
    const inPostalArea = isInPostalArea(e.latlng.lat, e.latlng.lng);
    
    let popupContent;
    if (inPostalArea) {
        popupContent = `
            <div style="text-align:center; padding: 10px;">
                <div style="font-weight:bold; margin-bottom: 5px;">üìç Tu ubicaci√≥n</div>
                <div class="code-display" style="font-size: 16px;">${code}</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                    ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}
                </div>
            </div>
        `;
    } else {
        popupContent = `
            <div style="text-align:center; padding: 10px;">
                <div style="font-weight:bold; margin-bottom: 5px;">üìç Fuera de cobertura</div>
                <div style="color: #e74c3c; font-size: 12px; margin-bottom: 5px;">
                    Sin c√≥digo postal asignado
                </div>
                <div style="font-size: 11px; color: #666;">
                    ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}
                </div>
            </div>
        `;
    }
    
    L.popup()
        .setLatLng(e.latlng)
        .setContent(popupContent)
        .openOn(mymap);
});

// Eventos del mapa
mymap.on('zoomend moveend', updateGrid);
mymap.on('zoomstart', () => selectionLayer.clearLayers());

// Inicializar
updateGrid();
</script>
</body>
</html>
